{% extends "layout.html" %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<style>
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    
    .dashboard-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        margin: 2rem;
        padding: 2rem;
        min-height: calc(100vh - 4rem);
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .dashboard-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }
    
    .welcome-text {
        position: relative;
        z-index: 1;
    }
    
    .welcome-text h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .welcome-text p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
    }
    
    /* Month Filter Styles */
    .month-filter-container {
        position: relative;
        z-index: 1;
        margin-top: 1.5rem;
    }
    
    /* Quick Access Styles */
    .quick-access-container {
        position: relative;
        z-index: 1;
        margin-top: 1rem;
    }
    
    .quick-access-btn {
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 25px;
        font-weight: 500;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }
    
    .quick-access-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .month-filter {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .month-filter-label {
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
        font-size: 1rem;
        margin: 0;
        white-space: nowrap;
    }
    
    .month-filter-select {
        background: rgba(255, 255, 255, 0.15);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        color: white;
        font-weight: 500;
        padding: 0.75rem 1rem;
        min-width: 200px;
        transition: all 0.3s ease;
    }
    
    .month-filter-select:focus {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
        box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
        color: white;
    }
    
    .month-filter-select option {
        background: #2c3e50;
        color: white;
        padding: 0.5rem;
    }
    
    /* Filter Row Styles */
    .month-filter-container .row {
        margin-top: 1rem;
    }
    
    .month-filter-container .col-md-3 {
        margin-bottom: 0;
    }
    
    .month-filter-container label {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    #currentButton {
        height: 48px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    #currentButton:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .stats-card {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }
    
    .stats-card .card-body {
        padding: 1.5rem;
        text-align: center;
    }
    
    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: white;
        font-size: 1.5rem;
    }
    
    .stats-value {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 0.5rem;
    }
    
    .stats-label {
        color: #6c757d;
        font-weight: 500;
    }
    
    /* Yesterday Balance Comparison Styles */
    .yesterday-balance-info {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .yesterday-balance-text {
        margin-bottom: 0.25rem;
    }
    
    .balance-improvement {
        font-weight: 600;
    }
    
    .improvement-text {
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .improvement-text.text-success {
        color: #28a745 !important;
    }
    
    .improvement-text.text-danger {
        color: #dc3545 !important;
    }
    
    .improvement-text.text-muted {
        color: #6c757d !important;
    }
    
    .content-card {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .content-card .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 20px 20px 0 0;
        padding: 1.5rem;
    }
    
    .content-card .card-header h5 {
        margin: 0;
        font-weight: 600;
    }
    
    .btn-action {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 15px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        color: white;
    }
    
    .btn-outline-action {
        background: transparent;
        border: 2px solid #667eea;
        color: #667eea;
        border-radius: 15px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-outline-action:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    .transaction-item {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.2s ease;
    }
    
    .transaction-item:hover {
        background-color: rgba(102, 126, 234, 0.05);
    }
    
    .transaction-item:last-child {
        border-bottom: none;
    }
    
    .transaction-amount {
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .transaction-amount.income {
        color: #28a745;
    }
    
    .transaction-amount.expense {
        color: #dc3545;
    }
    
    .transaction-amount.transfer {
        color: #17a2b8;
    }
    
    .quick-actions {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .quick-action-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 15px;
        padding: 1rem;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: block;
        text-align: center;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        color: white;
        text-decoration: none;
    }
    
    .quick-action-btn i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 767.98px) {
        .dashboard-container {
            margin: 0;
            padding: 1rem;
            border-radius: 0;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
        }
        
        .dashboard-header {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            padding-left: 4rem;
        }
        
        .welcome-text h1 {
            font-size: 2rem;
        }
        
        .welcome-text p {
            font-size: 1rem;
        }
        
        .month-filter-container .row {
            flex-direction: column;
        }
        
        .month-filter-container .col-md-3 {
            margin-bottom: 1rem;
        }
        
        .month-filter-select {
            min-width: 100%;
            font-size: 0.9rem;
        }
        
        #currentButton {
            height: 44px;
            font-size: 0.9rem;
        }
        
        .stats-card .card-body {
            padding: 1rem;
        }
        
        .stats-value {
            font-size: 1.5rem;
        }
        
        .stats-icon {
            width: 50px;
            height: 50px;
            font-size: 1.25rem;
        }
        
        .content-card .card-header {
            padding: 1rem;
        }
        
        .btn-action, .btn-outline-action {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .chart-container {
            height: 250px !important;
        }
    }
    
    @media (max-width: 575.98px) {
        .dashboard-container {
            margin: 0;
            padding: 0.75rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
        }
        
        .dashboard-header {
            padding: 1rem;
            margin-bottom: 1rem;
            padding-left: 3.5rem;
        }
        
        .welcome-text h1 {
            font-size: 1.75rem;
        }
        
        .stats-card .card-body {
            padding: 0.75rem;
        }
        
        .stats-value {
            font-size: 1.25rem;
        }
        
        .content-card .card-header {
            padding: 0.75rem;
        }
        
        .btn-action, .btn-outline-action {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }
        
        .chart-container {
            height: 200px !important;
        }
        
        .quick-actions {
            padding: 1rem;
        }
        
        .quick-action-btn {
            padding: 0.75rem;
            font-size: 0.9rem;
        }
        
        .quick-action-btn i {
            font-size: 1.25rem;
        }
    }
    
    /* Prevent horizontal scrolling and body movement */
    @media (max-width: 991.98px) {
        body {
            overflow-x: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            /* Android scroll fix */
            touch-action: pan-y;
        }
        
        .dashboard-container {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            overflow-y: auto;
            scroll-behavior: smooth;
            /* Android-specific improvements */
            touch-action: pan-y;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        .dashboard-header {
            padding-left: 4.5rem;
        }
    }
    
    /* Animation */
    .dashboard-container {
        animation: slideInUp 0.6s ease-out;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Touch and scroll optimizations */
    .dashboard-container {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        scroll-behavior: smooth;
        /* Android-specific scroll improvements */
        touch-action: pan-y;
        -webkit-overflow-scrolling: touch;
        overflow-scrolling: touch;
    }
    
    /* Enhanced mobile scrolling */
    @media (max-width: 991.98px) {
        .dashboard-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.6) rgba(255, 255, 255, 0.1);
        }
        
        .dashboard-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .dashboard-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .dashboard-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dashboard-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
    }
    
    /* Prevent text selection on mobile */
    @media (max-width: 991.98px) {
        .dashboard-container * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .dashboard-container input,
        .dashboard-container textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
    }
</style>

<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="welcome-text">
            <h1>Welcome back, {{ username }}!</h1>
            <p>Here's your financial overview for <span id="currentDateDisplay">Loading...</span></p>
        </div>
        
        <!-- Year, Month, Day Filter and Current Button -->
        <div class="month-filter-container">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="yearFilter" class="month-filter-label">
                        <i class="fas fa-calendar me-2"></i>Year:
                    </label>
                    <select id="yearFilter" class="form-select month-filter-select">
                        <option value="">Loading years...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="monthFilter" class="month-filter-label">
                        <i class="fas fa-calendar-alt me-2"></i>Month:
                    </label>
                    <select id="monthFilter" class="form-select month-filter-select">
                        <option value="">Loading months...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="dayFilter" class="month-filter-label">
                        <i class="fas fa-calendar-day me-2"></i>Day:
                    </label>
                    <select id="dayFilter" class="form-select month-filter-select">
                        <option value="">All days</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-outline-light quick-access-btn w-100" id="currentButton">
                        <i class="fas fa-home me-2"></i>Current
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Quick Access -->
        <div class="quick-access-container">
            <button type="button" class="btn btn-outline-light quick-access-btn" data-bs-toggle="modal" data-bs-target="#quickAccessModal">
                <i class="fas fa-bolt me-2"></i>Quick Access
            </button>
        </div>
    </div>

    <!-- Stats Cards Row -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stats-card h-100">
                        <div class="card-body">
                    <div class="stats-icon">
                        <i class="fas fa-wallet"></i>
                                </div>
                    <h5 class="stats-label">Total Balance</h5>
                    <h3 class="stats-value">Rp {{ "{:,.0f}".format((total_balance|default(0))|float) }}</h3>
                    <!-- Comparison info (yesterday for specific day, previous month for specific month) -->
                    <div id="balanceComparisonInfo" class="yesterday-balance-info" style="display: none;">
                        <div class="yesterday-balance-text">
                            <small class="text-muted"><span id="balanceComparisonLabel">Yesterday</span>: <span id="balanceComparisonAmount">-</span></small>
                        </div>
                        <div class="balance-improvement">
                            <small id="balanceImprovementText" class="improvement-text">-</small>
                        </div>
                    </div>
                                </div>
                            </div>
                        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stats-card h-100">
                        <div class="card-body">
                    <div class="stats-icon">
                        <i class="fas fa-arrow-up"></i>
                                </div>
                    <h5 class="stats-label">Income</h5>
                    <h3 class="stats-value">Rp {{ "{:,.0f}".format((total_income|default(0))|float) }}</h3>
                    <!-- Comparison info (yesterday for specific day, previous month for specific month) -->
                    <div id="incomeComparisonInfo" class="yesterday-balance-info" style="display: none;">
                        <div class="yesterday-balance-text">
                            <small class="text-muted"><span id="incomeComparisonLabel">Yesterday</span>: <span id="incomeComparisonAmount">-</span></small>
                        </div>
                        <div class="balance-improvement">
                            <small id="incomeImprovementText" class="improvement-text">-</small>
                        </div>
                    </div>
                                </div>
                            </div>
                        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stats-card h-100">
                        <div class="card-body">
                    <div class="stats-icon">
                        <i class="fas fa-arrow-down"></i>
                                </div>
                    <h5 class="stats-label">Expenses</h5>
                    <h3 class="stats-value">Rp {{ "{:,.0f}".format((total_expenses|default(0))|float) }}</h3>
                    <!-- Comparison info (yesterday for specific day, previous month for specific month) -->
                    <div id="expensesComparisonInfo" class="yesterday-balance-info" style="display: none;">
                        <div class="yesterday-balance-text">
                            <small class="text-muted"><span id="expensesComparisonLabel">Yesterday</span>: <span id="expensesComparisonAmount">-</span></small>
                        </div>
                        <div class="balance-improvement">
                            <small id="expensesImprovementText" class="improvement-text">-</small>
                        </div>
                    </div>
                                </div>
                            </div>
                        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card stats-card h-100">
                        <div class="card-body">
                    <div class="stats-icon">
                        <i class="fas fa-list"></i>
                                </div>
                    <h5 class="stats-label">Transactions</h5>
                    <h3 class="stats-value">{{ transaction_count|default(0) }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>

    <!-- Charts and Recent Transactions Row -->
    <div class="row g-4">
        <!-- Chart Section -->
        <div class="col-12 col-lg-8">
            <div class="card content-card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        <span id="chartTitle">Monthly Overview</span>
                    </h5>
                </div>
                        <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="monthlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

        <!-- Recent Transactions -->
        <div class="col-12 col-lg-4">
            <div class="card content-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>
                        Recent Transactions
                    </h5>
                    <a href="/transactions" class="btn btn-sm btn-outline-action">
                        <span class="d-none d-sm-inline">View All</span>
                        <span class="d-inline d-sm-none">All</span>
                    </a>
                </div>
                <div class="card-body p-0">
                    <!-- Debug: Show transaction count -->
                    <div class="text-muted small p-2" style="display: none;">
                        Debug: {{ transactions|length }} transactions found
                    </div>
                    {% if transactions %}
                        <div class="list-group list-group-flush">
                            {% for tx in transactions[:5] %}
                            <div class="transaction-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            {% if tx.type == 'income' %}
                                                <i class="fas fa-arrow-up text-success"></i>
                                            {% elif tx.type == 'expense' %}
                                                <i class="fas fa-arrow-down text-danger"></i>
                                            {% else %}
                                                <i class="fas fa-exchange-alt text-info"></i>
                                            {% endif %}
                </div>
                                <div>
                                            <div class="fw-medium text-truncate" style="max-width: 120px;">
                                                {{ tx.note or tx.description or 'No description' }}
                                </div>
                                            {% if (tx.category_name and tx.category_name != 'Unknown') or (tx.category and tx.category != 'Unknown') %}
                                            <small class="text-muted">{{ tx.category_name or tx.category or 'Uncategorized' }}</small>
                                            {% endif %}
                                            <small class="text-muted d-block">{{ tx.wallet_name or 'No Wallet' }}</small>
                                </div>
                            </div>
                                    <div class="text-end">
                                        <div class="transaction-amount {% if tx.type == 'income' %}income{% elif tx.type == 'expense' %}expense{% else %}transfer{% endif %}">
                                            Rp {{ "{:,.0f}".format((tx.amount|default(0))|float) }}
                        </div>
                                        <small class="text-muted">{{ tx.date if tx.date else 'N/A' }}</small>
                    </div>
                </div>
            </div>
                                        {% endfor %}
                            </div>
                            {% else %}
                        <div class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">No transactions yet</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                        </div>
                    </div>

    <!-- Top Tags Section -->
    <div class="row g-4 mt-4">
        <div class="col-12">
            <div class="card content-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tags me-2"></i>
                        Top Tags
                    </h5>
                </div>
                <div class="card-body">
                    {% if top_tags %}
                        <div class="row g-3">
                            {% for tag, count in top_tags %}
                            <div class="col-6 col-md-4 col-lg-2">
                                <div class="tag-item">
                                    <div class="tag-badge">
                                        <span class="tag-name">{{ tag.title() }}</span>
                                        <span class="tag-count">{{ count }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">No tags found</p>
                            <small class="text-muted">Start adding tags to your transactions to see them here</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Section -->
    <div class="row g-3 mt-4">
        <div class="col-12">
            <div class="quick-actions">
                <h5 class="mb-3 text-center">
                    <i class="fas fa-bolt me-2 text-primary"></i>
                    Quick Actions
                </h5>
                <div class="row g-3">
                    <div class="col-6 col-sm-3">
                        <a href="/transactions" class="quick-action-btn">
                            <i class="fas fa-list"></i>
                            <span class="d-none d-sm-inline">Transactions</span>
                            <span class="d-inline d-sm-none">Tx</span>
                        </a>
                        </div>
                    <div class="col-6 col-sm-3">
                        <a href="/goals" class="quick-action-btn">
                            <i class="fas fa-bullseye"></i>
                            <span class="d-none d-sm-inline">Goals</span>
                            <span class="d-inline d-sm-none">Goals</span>
                        </a>
                                </div>
                    <div class="col-6 col-sm-3">
                        <a href="/balance" class="quick-action-btn">
                            <i class="fas fa-wallet"></i>
                            <span class="d-none d-sm-inline">Balance</span>
                            <span class="d-inline d-sm-none">Bal</span>
                        </a>
                            </div>
                    <div class="col-6 col-sm-3">
                        <a href="/settings" class="quick-action-btn">
                            <i class="fas fa-cog"></i>
                            <span class="d-none d-sm-inline">Settings</span>
                            <span class="d-inline d-sm-none">Set</span>
                        </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Mobile-specific styles -->
<style>
@media (max-width: 767.98px) {
    .dashboard-container {
        padding: 0.5rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .chart-container {
        height: 250px !important;
    }
    
    .btn {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }
    
    .card-title {
        font-size: 0.875rem;
    }
    
    .h3 {
        font-size: 1.5rem;
    }
    
    .list-group-item {
        padding: 0.75rem 1rem;
    }
    
    .quick-actions .btn {
        min-height: 80px;
    }
    
    /* Tags Section Styles */
    .tag-item {
        text-align: center;
    }
    
    .tag-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 80px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .tag-badge:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .tag-name {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        text-transform: capitalize;
    }
    
    .tag-count {
        font-size: 0.75rem;
        opacity: 0.8;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.25rem 0.5rem;
        border-radius: 10px;
        font-weight: 500;
    }
    
    @media (max-width: 768px) {
        .tag-badge {
            min-height: 70px;
            padding: 0.75rem;
        }
        
        .tag-name {
            font-size: 0.8rem;
        }
        
        .tag-count {
            font-size: 0.7rem;
        }
    }
}

</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize year, month and day filters with a small delay to ensure DOM is ready
    setTimeout(() => {
        initializeYearFilter();
        initializeMonthFilter();
        initializeDayFilter();
        initializeCurrentButton();
    }, 100);
    
    // Prevent zoom and pan gestures on mobile
    if (window.innerWidth <= 991.98) {
        // Prevent zoom
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        
        // Prevent double tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Prevent pinch zoom but allow scrolling
        document.addEventListener('touchmove', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
    }
    
    // Chart data
    const ctx = document.getElementById('monthlyChart').getContext('2d');
    
    // Initialize with current month data (will be updated when month filter loads)
    const monthlyData = {
        labels: [],
        income: [],
        expenses: []
    };
    
    window.monthlyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: monthlyData.labels,
            datasets: [{
                label: 'Income',
                data: monthlyData.income,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Expenses',
                data: monthlyData.expenses,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
});

// Year Filter Functions
function initializeYearFilter() {
    const yearFilter = document.getElementById('yearFilter');
    if (!yearFilter) {
        console.error('Year filter element not found');
        return;
    }
    
    // Generate year options (current year and previous 5 years)
    const years = generateYearOptions();
    
    // Clear existing options
    yearFilter.innerHTML = '';
    
    // Add year options
    years.forEach((year, index) => {
        const option = document.createElement('option');
        option.value = year.value;
        option.textContent = year.label;
        
        // Highlight current year (first in the list)
        if (index === 0) {
            option.selected = true;
        }
        
        yearFilter.appendChild(option);
    });
    
    // Set current year as default
    const currentYear = new Date().getFullYear().toString();
    yearFilter.value = currentYear;
    
    // Add change event listener
    yearFilter.addEventListener('change', function() {
        const selectedYear = this.value;
        if (selectedYear && selectedYear !== 'undefined') {
            // Reset month and day filters when year changes
            resetMonthFilter();
            resetDayFilter();
            // Update display immediately to show the selected year
            updateCurrentDateDisplay(selectedYear);
            // Load data for the entire year (no specific month or day)
            loadDashboardData(selectedYear);
        }
    });
    
    // Set default to today's date (this will also load the data)
    setDefaultToToday();
}

function generateYearOptions() {
    const years = [];
    const currentYear = new Date().getFullYear();
    
    for (let i = 0; i < 6; i++) {
        const year = currentYear - i;
        years.push({
            value: year.toString(),
            label: i === 0 ? `${year} (Current Year)` : year.toString()
        });
    }
    
    return years;
}

function resetMonthFilter() {
    const monthFilter = document.getElementById('monthFilter');
    if (monthFilter) {
        monthFilter.innerHTML = '<option value="">All Months</option>';
        monthFilter.value = '';
    }
}

function setDefaultToToday() {
    try {
        const today = new Date();
        const currentYear = today.getFullYear().toString();
        const currentMonth = (today.getMonth() + 1).toString().padStart(2, '0');
        const currentDay = today.getDate().toString().padStart(2, '0');
        
        // Set year filter
        const yearFilter = document.getElementById('yearFilter');
        if (yearFilter) {
            yearFilter.value = currentYear;
        }
        
        // Populate month filter for current year
        populateMonthFilter(currentYear);
        
        // Set month filter to current month
        const monthFilter = document.getElementById('monthFilter');
        if (monthFilter) {
            const currentMonthValue = `${currentYear}-${currentMonth}`;
            monthFilter.value = currentMonthValue;
        }
        
        // Populate day filter for current month
        populateDayFilter(currentYear, currentMonth);
        
        // Set day filter to today
        const dayFilter = document.getElementById('dayFilter');
        if (dayFilter) {
            dayFilter.value = currentDay;
        }
        
        // Load data for today
        loadDashboardData(currentYear, `${currentYear}-${currentMonth}`, currentDay);
        
        // Update display to show today's date
        updateCurrentDateDisplay(currentYear, `${currentYear}-${currentMonth}`, currentDay);
        
    } catch (error) {
        console.error('Error setting default to today:', error);
    }
}

function initializeCurrentButton() {
    const currentButton = document.getElementById('currentButton');
    if (!currentButton) {
        console.error('Current button element not found');
        return;
    }
    
    // Add click event listener
    currentButton.addEventListener('click', function() {
        // Reset all filters to current date
        setDefaultToToday();
        
        // Add visual feedback
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
            this.style.transform = 'scale(1)';
        }, 150);
    });
}

// Month Filter Functions
function initializeMonthFilter() {
    const monthFilter = document.getElementById('monthFilter');
    if (!monthFilter) {
        console.error('Month filter element not found');
        return;
    }
    
    // Generate month options (current month and previous 11 months)
    const months = generateMonthOptions();
    
    // Clear existing options
    monthFilter.innerHTML = '<option value="">All Months</option>';
    
    // Add month options
    months.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = month.value;
        option.textContent = month.label;
        
        // Highlight current month (first in the list)
        if (index === 0) {
            option.textContent = `${month.label} (Current)`;
        }
        
        monthFilter.appendChild(option);
    });
    
    // Set current month as default
    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format
    monthFilter.value = currentMonth;
    
    // Add change event listener
    monthFilter.addEventListener('change', function() {
        const selectedMonth = this.value;
        const selectedYear = document.getElementById('yearFilter').value;
        if (selectedMonth && selectedMonth !== 'undefined' && selectedYear && selectedYear !== 'undefined') {
            // Reset day filter when month changes and set to "All Days"
            resetDayFilter();
            // Update display immediately to show the selected month and year
            updateCurrentDateDisplay(selectedYear, selectedMonth);
            // Load data for the entire month (no specific day)
            loadDashboardData(selectedYear, selectedMonth);
        }
    });
}

function generateMonthOptions() {
    const months = [];
    const currentDate = new Date();
    
    for (let i = 0; i < 12; i++) {
        const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const monthName = date.toLocaleDateString('en-US', { month: 'long' });
        
        months.push({
            value: `${year}-${month.toString().padStart(2, '0')}`,
            label: `${monthName} ${year}`
        });
    }
    
    return months;
}

function populateMonthFilter(year) {
    const monthFilter = document.getElementById('monthFilter');
    if (!monthFilter) return;
    
    try {
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth() + 1; // 1-based month
        
        // Clear existing options
        monthFilter.innerHTML = '<option value="">All Months</option>';
        
        // Add month options for the selected year
        for (let month = 1; month <= 12; month++) {
            const date = new Date(parseInt(year), month - 1, 1);
            const monthName = date.toLocaleDateString('en-US', { month: 'long' });
            
            const option = document.createElement('option');
            option.value = `${year}-${month.toString().padStart(2, '0')}`;
            option.textContent = monthName;
            monthFilter.appendChild(option);
        }
        
        // Auto-select current month if we're in the current year
        if (parseInt(year) === currentYear) {
            const currentMonthValue = `${year}-${currentMonth.toString().padStart(2, '0')}`;
            monthFilter.value = currentMonthValue;
            
            // Don't load data here - let setDefaultToToday() handle the final data loading
        }
        
    } catch (error) {
        console.error('Error populating month filter:', error);
    }
}

// Day Filter Functions
function initializeDayFilter() {
    const dayFilter = document.getElementById('dayFilter');
    if (!dayFilter) {
        console.error('Day filter element not found');
        return;
    }
    
    // Add change event listener
    dayFilter.addEventListener('change', function() {
        const selectedDay = this.value;
        const selectedMonth = document.getElementById('monthFilter').value;
        const selectedYear = document.getElementById('yearFilter').value;
        
        if (selectedDay && selectedDay !== '' && selectedMonth && selectedMonth !== 'undefined' && selectedYear && selectedYear !== 'undefined') {
            // Update display immediately to show the selected day, month and year
            updateCurrentDateDisplay(selectedYear, selectedMonth, selectedDay);
            loadDashboardData(selectedYear, selectedMonth, selectedDay);
        }
    });
}

function resetDayFilter() {
    const dayFilter = document.getElementById('dayFilter');
    if (dayFilter) {
        dayFilter.innerHTML = '<option value="">All Days</option>';
        dayFilter.value = '';
    }
}

function populateDayFilter(year, month) {
    const dayFilter = document.getElementById('dayFilter');
    if (!dayFilter) return;
    
    try {
        // Parse year and month
        const selectedMonth = new Date(parseInt(year), parseInt(month) - 1, 1);
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();
        const currentDay = today.getDate();
        
        // Check if selected month is the current month
        const isCurrentMonth = (selectedMonth.getFullYear() === currentYear && 
                               selectedMonth.getMonth() === currentMonth);
        
        // Clear existing options
        dayFilter.innerHTML = '<option value="">All Days</option>';
        
        if (isCurrentMonth) {
            // For current month, use relative dates (Today, Yesterday, etc.)
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                // Only include dates from the selected month
                if (date.getFullYear() === selectedMonth.getFullYear() && 
                    date.getMonth() === selectedMonth.getMonth()) {
                    
                    const option = document.createElement('option');
                    const dayStr = date.getDate().toString().padStart(2, '0');
                    option.value = dayStr;
                    
                    // Generate relative date text
                    let relativeText = '';
                    if (i === 0) {
                        relativeText = 'Today';
                    } else if (i === 1) {
                        relativeText = 'Yesterday';
                    } else {
                        relativeText = `${i} days ago`;
                    }
                    
                    // Format date (e.g., "3 Aug")
                    const monthName = date.toLocaleDateString('en-US', { month: 'short' });
                    const dayNum = date.getDate();
                    
                    option.textContent = `${relativeText} - ${dayNum} ${monthName}`;
                    dayFilter.appendChild(option);
                }
            }
            
            // Auto-select "Today" if we're in the current month and today exists in the options
            const todayOption = dayFilter.querySelector(`option[value="${currentDay.toString().padStart(2, '0')}"]`);
            if (todayOption) {
                dayFilter.value = currentDay.toString().padStart(2, '0');
                
                // Automatically load data for today
                const selectedYear = document.getElementById('yearFilter').value;
                const selectedMonth = document.getElementById('monthFilter').value;
                if (selectedYear && selectedMonth) {
                    loadDashboardData(selectedYear, selectedMonth, currentDay.toString().padStart(2, '0'));
                }
            }
        } else {
            // For non-current months, show just the day numbers (1, 2, 3, ..., 31)
            const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const option = document.createElement('option');
                const dayStr = day.toString().padStart(2, '0');
                option.value = dayStr;
                
                // Show just the day number
                option.textContent = day.toString();
                dayFilter.appendChild(option);
            }
        }
        
    } catch (error) {
        console.error('Error populating day filter:', error);
    }
}

async function loadDashboardData(year, month = null, day = null) {
    try {
        // Validate year parameter
        if (!year || year === 'undefined' || year === '') {
            console.error('Invalid year parameter:', year);
            return;
        }
        
        console.log(`Loading dashboard data for year: ${year}${month ? `, month: ${month}` : ''}${day ? `, day: ${day}` : ''}`);
        
        // Show loading state
        showLoadingState();
        
        // Populate month filter when year changes
        if (!month) {
            populateMonthFilter(year);
        }
        
        // Populate day filter when month changes
        if (month && !day) {
            populateDayFilter(year, month);
        }
        
        // Fetch data for the selected year, month and day
        let url = `/api/dashboard-data?year=${year}`;
        if (month) {
            url += `&month=${month}`;
        }
        if (day) {
            url += `&day=${day}`;
        }
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('Failed to fetch dashboard data');
        }
        
        const data = await response.json();
        
        // Update dashboard with new data
        updateDashboardData(data);
        
        // Update chart
        updateChart(data.chartData);
        
        // Update current date display
        updateCurrentDateDisplay(year, month, day);
        
        // Update chart title
        updateChartTitle(year, month, day);
        
        console.log('Dashboard data loaded successfully');
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showErrorState('Failed to load dashboard data');
    }
}

function showLoadingState() {
    // Add loading indicator to stats cards
    const statsValues = document.querySelectorAll('.stats-value');
    statsValues.forEach(element => {
        element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    });
}

function updateDashboardData(data) {
    // Update total balance
    const totalBalanceElement = document.querySelector('.stats-value');
    if (totalBalanceElement && data.total_balance !== undefined) {
        if (data.total_balance === "-") {
            totalBalanceElement.textContent = "-";
        } else {
            totalBalanceElement.textContent = `Rp ${data.total_balance.toLocaleString('id-ID', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            })}`;
        }
    }
    
    // Update comparison info (yesterday for specific day, previous month for specific month)
    updateBalanceComparisonInfo(data);
    updateIncomeComparisonInfo(data);
    updateExpensesComparisonInfo(data);
    
    // Update income
    const incomeElement = document.querySelectorAll('.stats-value')[1];
    if (incomeElement && data.total_income !== undefined) {
        incomeElement.textContent = `Rp ${data.total_income.toLocaleString('id-ID', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        })}`;
    }
    
    // Update expenses
    const expensesElement = document.querySelectorAll('.stats-value')[2];
    if (expensesElement && data.total_expenses !== undefined) {
        expensesElement.textContent = `Rp ${data.total_expenses.toLocaleString('id-ID', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        })}`;
    }
    
    // Update transaction count
    const transactionCountElement = document.querySelectorAll('.stats-value')[3];
    if (transactionCountElement && data.transaction_count !== undefined) {
        transactionCountElement.textContent = data.transaction_count;
    }
    
    // Update recent transactions
    updateRecentTransactions(data.recent_transactions);
}

function updateBalanceComparisonInfo(data) {
    const balanceComparisonInfo = document.getElementById('balanceComparisonInfo');
    const balanceComparisonLabel = document.getElementById('balanceComparisonLabel');
    const balanceComparisonAmount = document.getElementById('balanceComparisonAmount');
    const balanceImprovementText = document.getElementById('balanceImprovementText');
    
    if (!balanceComparisonInfo || !balanceComparisonLabel || !balanceComparisonAmount || !balanceImprovementText) {
        return;
    }
    
    // Determine if we're showing yesterday or previous month data
    let comparisonData = null;
    let improvementData = null;
    let labelText = '';
    
    if (data.yesterday_balance !== null && data.yesterday_balance !== undefined) {
        // Show yesterday's data (specific day selected)
        comparisonData = data.yesterday_balance;
        improvementData = data.balance_improvement;
        labelText = 'Yesterday';
    } else if (data.previous_month_balance !== null && data.previous_month_balance !== undefined) {
        // Show previous month's data (specific month selected)
        comparisonData = data.previous_month_balance;
        improvementData = data.previous_month_balance_improvement;
        labelText = 'Previous Month';
    }
    
    if (comparisonData !== null) {
        balanceComparisonInfo.style.display = 'block';
        balanceComparisonLabel.textContent = labelText;
        
        // Update comparison amount
        if (comparisonData === "-") {
            balanceComparisonAmount.textContent = "No data";
        } else {
            balanceComparisonAmount.textContent = `Rp ${parseFloat(comparisonData).toLocaleString('id-ID', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            })}`;
        }
        
        // Update improvement text
        if (improvementData !== null && improvementData !== undefined) {
            const improvement = parseFloat(improvementData);
            if (improvement > 0) {
                balanceImprovementText.textContent = `+Rp ${improvement.toLocaleString('id-ID', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                })} ↗️`;
                balanceImprovementText.className = 'improvement-text text-success';
            } else if (improvement < 0) {
                balanceImprovementText.textContent = `Rp ${Math.abs(improvement).toLocaleString('id-ID', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                })} ↘️`;
                balanceImprovementText.className = 'improvement-text text-danger';
            } else {
                balanceImprovementText.textContent = 'No change';
                balanceImprovementText.className = 'improvement-text text-muted';
            }
        } else {
            balanceImprovementText.textContent = 'Unable to calculate';
            balanceImprovementText.className = 'improvement-text text-muted';
        }
    } else {
        // Hide comparison info when not viewing a specific date or month
        balanceComparisonInfo.style.display = 'none';
    }
}

function updateIncomeComparisonInfo(data) {
    const incomeComparisonInfo = document.getElementById('incomeComparisonInfo');
    const incomeComparisonLabel = document.getElementById('incomeComparisonLabel');
    const incomeComparisonAmount = document.getElementById('incomeComparisonAmount');
    const incomeImprovementText = document.getElementById('incomeImprovementText');
    
    if (!incomeComparisonInfo || !incomeComparisonLabel || !incomeComparisonAmount || !incomeImprovementText) {
        return;
    }
    
    // Determine if we're showing yesterday or previous month data
    let comparisonData = null;
    let improvementData = null;
    let labelText = '';
    
    if (data.yesterday_income !== null && data.yesterday_income !== undefined) {
        // Show yesterday's data (specific day selected)
        comparisonData = data.yesterday_income;
        improvementData = data.income_improvement;
        labelText = 'Yesterday';
    } else if (data.previous_month_income !== null && data.previous_month_income !== undefined) {
        // Show previous month's data (specific month selected)
        comparisonData = data.previous_month_income;
        improvementData = data.previous_month_income_improvement;
        labelText = 'Previous Month';
    }
    
    if (comparisonData !== null) {
        incomeComparisonInfo.style.display = 'block';
        incomeComparisonLabel.textContent = labelText;
        
        // Update comparison amount
        incomeComparisonAmount.textContent = `Rp ${parseFloat(comparisonData).toLocaleString('id-ID', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        })}`;
        
        // Update improvement text
        if (improvementData !== null && improvementData !== undefined) {
            const improvement = parseFloat(improvementData);
            if (improvement > 0) {
                incomeImprovementText.textContent = `+Rp ${improvement.toLocaleString('id-ID', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                })} ↗️`;
                incomeImprovementText.className = 'improvement-text text-success';
            } else if (improvement < 0) {
                incomeImprovementText.textContent = `Rp ${Math.abs(improvement).toLocaleString('id-ID', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                })} ↘️`;
                incomeImprovementText.className = 'improvement-text text-danger';
            } else {
                incomeImprovementText.textContent = 'No change';
                incomeImprovementText.className = 'improvement-text text-muted';
            }
        } else {
            incomeImprovementText.textContent = 'Unable to calculate';
            incomeImprovementText.className = 'improvement-text text-muted';
        }
    } else {
        // Hide comparison info when not viewing a specific date or month
        incomeComparisonInfo.style.display = 'none';
    }
}

function updateExpensesComparisonInfo(data) {
    const expensesComparisonInfo = document.getElementById('expensesComparisonInfo');
    const expensesComparisonLabel = document.getElementById('expensesComparisonLabel');
    const expensesComparisonAmount = document.getElementById('expensesComparisonAmount');
    const expensesImprovementText = document.getElementById('expensesImprovementText');
    
    if (!expensesComparisonInfo || !expensesComparisonLabel || !expensesComparisonAmount || !expensesImprovementText) {
        return;
    }
    
    // Determine if we're showing yesterday or previous month data
    let comparisonData = null;
    let improvementData = null;
    let labelText = '';
    
    if (data.yesterday_expenses !== null && data.yesterday_expenses !== undefined) {
        // Show yesterday's data (specific day selected)
        comparisonData = data.yesterday_expenses;
        improvementData = data.expenses_improvement;
        labelText = 'Yesterday';
    } else if (data.previous_month_expenses !== null && data.previous_month_expenses !== undefined) {
        // Show previous month's data (specific month selected)
        comparisonData = data.previous_month_expenses;
        improvementData = data.previous_month_expenses_improvement;
        labelText = 'Previous Month';
    }
    
    if (comparisonData !== null) {
        expensesComparisonInfo.style.display = 'block';
        expensesComparisonLabel.textContent = labelText;
        
        // Update comparison amount
        expensesComparisonAmount.textContent = `Rp ${parseFloat(comparisonData).toLocaleString('id-ID', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        })}`;
        
        // Update improvement text (for expenses, less spending is good, more spending is bad)
        if (improvementData !== null && improvementData !== undefined) {
            const improvement = parseFloat(improvementData);
            if (improvement < 0) {
                // Less spending than comparison period (good)
                expensesImprovementText.textContent = `Rp ${Math.abs(improvement).toLocaleString('id-ID', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                })} less ↘️`;
                expensesImprovementText.className = 'improvement-text text-success';
            } else if (improvement > 0) {
                // More spending than comparison period (bad)
                expensesImprovementText.textContent = `+Rp ${improvement.toLocaleString('id-ID', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                })} more ↗️`;
                expensesImprovementText.className = 'improvement-text text-danger';
            } else {
                expensesImprovementText.textContent = 'No change';
                expensesImprovementText.className = 'improvement-text text-muted';
            }
        } else {
            expensesImprovementText.textContent = 'Unable to calculate';
            expensesImprovementText.className = 'improvement-text text-muted';
        }
    } else {
        // Hide comparison info when not viewing a specific date or month
        expensesComparisonInfo.style.display = 'none';
    }
}

function updateRecentTransactions(transactions) {
    const transactionsContainer = document.querySelector('.list-group');
    if (!transactionsContainer) return;
    
    if (transactions && transactions.length > 0) {
        transactionsContainer.innerHTML = '';
        
        transactions.slice(0, 5).forEach(tx => {
            const transactionItem = createTransactionItem(tx);
            transactionsContainer.appendChild(transactionItem);
        });
    } else {
        transactionsContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted mb-0">No transactions for this month</p>
            </div>
        `;
    }
}

function createTransactionItem(tx) {
    const item = document.createElement('div');
    item.className = 'transaction-item';
    
    const iconClass = tx.type === 'income' ? 'fas fa-arrow-up text-success' : 
                     tx.type === 'expense' ? 'fas fa-arrow-down text-danger' : 
                     'fas fa-exchange-alt text-info';
    
    const amountClass = tx.type === 'income' ? 'income' : 
                       tx.type === 'expense' ? 'expense' : 
                       'transfer';
    
    item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="${iconClass}"></i>
                </div>
                <div>
                    <div class="fw-medium text-truncate" style="max-width: 120px;">
                        ${tx.note || tx.description || 'No description'}
                    </div>
                    ${(tx.category_name && tx.category_name !== 'Unknown') || (tx.category && tx.category !== 'Unknown') ? 
                        `<small class="text-muted">${tx.category_name || tx.category || 'Uncategorized'}</small>` : ''}
                    <small class="text-muted d-block">${tx.wallet_name || 'No Wallet'}</small>
                </div>
            </div>
            <div class="text-end">
                <div class="transaction-amount ${amountClass}">
                    Rp ${tx.amount.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                </div>
                <small class="text-muted">${tx.date ? new Date(tx.date).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' }) : 'N/A'}</small>
            </div>
        </div>
    `;
    
    return item;
}

function updateChart(chartData) {
    if (window.monthlyChart && chartData) {
        window.monthlyChart.data.labels = chartData.labels;
        window.monthlyChart.data.datasets[0].data = chartData.income;
        window.monthlyChart.data.datasets[1].data = chartData.expenses;
        window.monthlyChart.update();
    }
}

function updateCurrentDateDisplay(year, month, day) {
    try {
        const dateDisplay = document.getElementById('currentDateDisplay');
        if (dateDisplay) {
            if (day && day !== '' && month && month !== '') {
                // Show specific date (e.g., "3 Sept 2025")
                try {
                    const [yearStr, monthNum] = month.split('-');
                    const date = new Date(parseInt(yearStr), parseInt(monthNum) - 1, parseInt(day));
                    
                    // Format date (e.g., "3 Sept 2025")
                    const dayNum = date.getDate();
                    const monthName = date.toLocaleDateString('en-US', { month: 'short' });
                    const yearNum = date.getFullYear();
                    
                    dateDisplay.textContent = `${dayNum} ${monthName} ${yearNum}`;
                } catch (error) {
                    console.error('Error formatting date display:', error);
                    dateDisplay.textContent = 'Today';
                }
            } else if (month && month !== '') {
                // Show month and year (e.g., "September 2025")
                try {
                    const [yearStr, monthNum] = month.split('-');
                    const date = new Date(parseInt(yearStr), parseInt(monthNum) - 1, 1);
                    const monthName = date.toLocaleDateString('en-US', { month: 'long' });
                    const yearNum = date.getFullYear();
                    
                    dateDisplay.textContent = `${monthName} ${yearNum}`;
                } catch (error) {
                    console.error('Error formatting month display:', error);
                    dateDisplay.textContent = 'This Month';
                }
            } else if (year && year !== '') {
                // Show year only (e.g., "2025")
                dateDisplay.textContent = year;
            } else {
                dateDisplay.textContent = 'Today';
            }
        }
    } catch (error) {
        console.error('Error updating current date display:', error);
    }
}

function updateChartTitle(year, month, day) {
    try {
        const chartTitle = document.getElementById('chartTitle');
        if (chartTitle) {
            if (day && day !== '' && month && month !== '') {
                // Daily view with hourly breakdown
                try {
                    const [yearStr, monthNum] = month.split('-');
                    const date = new Date(parseInt(yearStr), parseInt(monthNum) - 1, parseInt(day));
                    
                    // Format date (e.g., "3 Aug")
                    const monthName = date.toLocaleDateString('en-US', { month: 'short' });
                    const dayNum = date.getDate();
                    
                    chartTitle.textContent = `Daily Overview - ${dayNum} ${monthName} (Hourly Breakdown)`;
                } catch (error) {
                    console.error('Error formatting chart title:', error);
                    chartTitle.textContent = 'Daily Overview (Hourly Breakdown)';
                }
            } else if (month && month !== '') {
                // Monthly view with daily breakdown
                try {
                    const [yearStr, monthNum] = month.split('-');
                    const date = new Date(parseInt(yearStr), parseInt(monthNum) - 1, 1);
                    const monthName = date.toLocaleDateString('en-US', { month: 'long' });
                    
                    chartTitle.textContent = `Monthly Overview - ${monthName}`;
                } catch (error) {
                    console.error('Error formatting chart title:', error);
                    chartTitle.textContent = 'Monthly Overview';
                }
            } else if (year && year !== '') {
                // Yearly view
                chartTitle.textContent = `Yearly Overview - ${year}`;
            } else {
                chartTitle.textContent = 'Overview';
            }
        }
    } catch (error) {
        console.error('Error updating chart title:', error);
    }
}

function showErrorState(message) {
    // Show error message
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger alert-dismissible fade show';
    errorDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.dashboard-container');
    if (container) {
        container.insertBefore(errorDiv, container.firstChild);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    }
    

}
</script>

<!-- Quick Access Modal -->
<div class="modal fade" id="quickAccessModal" tabindex="-1" aria-labelledby="quickAccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickAccessModalLabel">
                    <i class="fas fa-bolt me-2"></i>Quick Access
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <!-- Quick Actions -->
                    <div class="col-12">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-rocket me-2"></i>Quick Actions
                        </h6>
                    </div>
                    
                    <div class="col-6 col-md-3">
                        <a href="/transactions" class="btn btn-outline-primary w-100 quick-action-btn">
                            <i class="fas fa-plus-circle mb-2"></i>
                            <div>Add Transaction</div>
                        </a>
                    </div>
                    
                    <div class="col-6 col-md-3">
                        <a href="/balance" class="btn btn-outline-success w-100 quick-action-btn">
                            <i class="fas fa-wallet mb-2"></i>
                            <div>Update Balance</div>
                        </a>
                    </div>
                    
                    <div class="col-6 col-md-3">
                        <a href="/goals" class="btn btn-outline-warning w-100 quick-action-btn">
                            <i class="fas fa-bullseye mb-2"></i>
                            <div>Set Goals</div>
                        </a>
                    </div>
                    
                    <div class="col-6 col-md-3">
                        <a href="/settings" class="btn btn-outline-info w-100 quick-action-btn">
                            <i class="fas fa-cog mb-2"></i>
                            <div>Settings</div>
                        </a>
                    </div>
                    

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Access Modal Styles -->
<style>
.quick-action-btn {
    height: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 15px;
    transition: all 0.3s ease;
    text-decoration: none;
    color: inherit;
}

.quick-action-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    color: inherit;
    text-decoration: none;
}

.quick-action-btn i {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.quick-action-btn div {
    font-size: 0.85rem;
    font-weight: 500;
}

.modal-content {
    border-radius: 20px;
    border: none;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px 20px 0 0;
    border-bottom: none;
}

.modal-title {
    font-weight: 600;
}

.btn-close {
    filter: invert(1);
}
</style>

{% endblock %}



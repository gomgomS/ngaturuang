{% extends 'layout.html' %}

{% block head %}
<style>
.action-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.action-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    border-color: #007bff;
}

.action-card:hover .action-icon i {
    transform: scale(1.1);
}

.action-icon i {
    transition: transform 0.3s ease;
}

.action-card .card-body {
    padding: 2rem 1rem;
}

@media (max-width: 768px) {
    .action-card .card-body {
        padding: 1.5rem 1rem;
    }
    
    .action-card h5 {
        font-size: 1.1rem;
    }
    
    .action-card p {
        font-size: 0.9rem;
    }
}

/* Styling for disabled wallet options */
#add_wallet_id option:disabled {
    color: #6c757d;
    font-style: italic;
    background-color: #f8f9fa;
}

#add_wallet_id option:disabled:hover {
    background-color: #e9ecef;
}

/* Styling for disabled category options */
#add_category_id option:disabled,
#edit_category_id option:disabled {
    color: #6c757d;
    font-style: italic;
    background-color: #f8f9fa;
}

#add_category_id option:disabled:hover,
#edit_category_id option:disabled:hover {
    background-color: #e9ecef;
}

/* Mobile Transaction Cards */
.transaction-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.transaction-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

.transaction-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: rgba(0, 123, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
}

.transaction-type {
    font-size: 0.95rem;
    font-weight: 600;
    color: #333;
}

.transaction-amount {
    font-size: 1.1rem;
    font-weight: 700;
}

.transaction-note {
    background: #f8f9fa;
    padding: 0.5rem;
    border-radius: 6px;
    border-left: 3px solid #007bff;
}

.transfer-details {
    background: #f8f9fa !important;
    border: 1px solid #e9ecef;
}

.transaction-tags .badge {
    font-size: 0.65rem;
    padding: 0.25rem 0.5rem;
}

.transaction-actions .btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.8rem;
}

.transaction-id {
    font-size: 0.7rem;
    color: #6c757d;
}

/* Mobile-specific adjustments */
@media (max-width: 576px) {
    .transaction-card .card-body {
        padding: 0.75rem !important;
    }
    
    .transaction-icon {
        width: 30px;
        height: 30px;
    }
    
    .transaction-type {
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .transaction-amount {
        font-size: 0.9rem;
    }
    
    .transaction-actions .btn {
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
    }
    
    .transaction-note {
        font-size: 0.7rem;
        padding: 0.3rem;
    }
    
    .transfer-details {
        font-size: 0.7rem;
        padding: 0.3rem !important;
    }
    
    .transaction-tags .badge {
        font-size: 0.6rem;
        padding: 0.2rem 0.4rem;
    }
    
    .transaction-id {
        font-size: 0.65rem;
    }
    
    .wallet-selector .form-select {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    .btn-sm {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
    }
}
</style>
{% endblock %}

{% block content %}
<style>
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    
    .transactions-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        margin: 2rem;
        padding: 2rem;
        min-height: calc(100vh - 4rem);
    }
    
    .transactions-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .transactions-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }
    
    .transactions-header h1 {
        position: relative;
        z-index: 1;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .transactions-header p {
        position: relative;
        z-index: 1;
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
    }
    
    .content-card {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .content-card .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 20px 20px 0 0;
        padding: 1.5rem;
    }
    
    .content-card .card-header h5 {
        margin: 0;
        font-weight: 600;
    }
    
    .btn-action {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 15px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        color: white;
    }
    
    .btn-outline-action {
        background: transparent;
        border: 2px solid #667eea;
        color: #667eea;
        border-radius: 15px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-outline-action:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 767.98px) {
        .transactions-container {
            margin: 0;
            padding: 1rem;
            border-radius: 0;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
        }
        
        .transactions-header {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            padding-left: 4rem;
        }
        
        .transactions-header h1 {
            font-size: 2rem;
        }
        
        .transactions-header p {
            font-size: 1rem;
        }
        
        .content-card .card-header {
            padding: 1rem;
        }
        
        .btn-action, .btn-outline-action {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
    }
    
    @media (max-width: 575.98px) {
        .transactions-container {
            margin: 0;
            padding: 0.75rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
        }
        
        .transactions-header {
            padding: 1rem;
            margin-bottom: 1rem;
            padding-left: 3.5rem;
        }
        
        .transactions-header h1 {
            font-size: 1.75rem;
        }
        
        .content-card .card-header {
            padding: 0.75rem;
        }
        
        .btn-action, .btn-outline-action {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }
    }
    
    /* Prevent horizontal scrolling and body movement */
    @media (max-width: 991.98px) {
        body {
            overflow-x: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            touch-action: pan-y;
        }
        
        .transactions-container {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            overflow-y: auto;
            scroll-behavior: smooth;
            touch-action: pan-y;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        .transactions-header {
            padding-left: 4.5rem;
        }
    }
    
    /* Animation */
    .transactions-container {
        animation: slideInUp 0.6s ease-out;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Touch and scroll optimizations */
    .transactions-container {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        scroll-behavior: smooth;
        touch-action: pan-y;
        -webkit-overflow-scrolling: touch;
        overflow-scrolling: touch;
    }
    
    /* Enhanced mobile scrolling */
    @media (max-width: 991.98px) {
        .transactions-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.6) rgba(255, 255, 255, 0.1);
        }
        
        .transactions-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .transactions-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .transactions-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .transactions-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
    }
    
    /* Prevent text selection on mobile */
    @media (max-width: 991.98px) {
        .transactions-container * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .transactions-container input,
        .transactions-container textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
    }
</style>

<div class="transactions-container">


    <div class="row">
        <div class="col-12">
            <div class="text-center mb-5">
                
                <!-- Main Action Buttons -->
                <div class="row justify-content-center">
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card h-100 action-card content-card" onclick="showAddTransaction()">
                            <div class="card-body text-center p-4">
                                <div class="action-icon mb-3">
                                    <i class="fas fa-plus-circle fa-3x text-primary"></i>
                                </div>
                                <h5 class="card-title">Add Transaction</h5>
                                <p class="card-text text-muted">Create new income or expense transaction</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card h-100 action-card content-card" onclick="showTransactionHistory()">
                            <div class="card-body text-center p-4">
                                <div class="action-icon mb-3">
                                    <i class="fas fa-history fa-3x text-success"></i>
                                </div>
                                <h5 class="card-title">Transaction History</h5>
                                <p class="card-text text-muted">View and filter all your transactions</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card h-100 action-card content-card" onclick="showTransfer()">
                            <div class="card-body text-center p-4">
                                <div class="action-icon mb-3">
                                    <i class="fas fa-exchange-alt fa-3x text-info"></i>
                                </div>
                                <h5 class="card-title">Transfer</h5>
                                <p class="card-text text-muted">Transfer money between your wallets</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card h-100 action-card content-card" onclick="showModifiedBalance()">
                            <div class="card-body text-center p-4">
                                <div class="action-icon mb-3">
                                    <i class="fas fa-balance-scale fa-3x text-warning"></i>
                                </div>
                                <h5 class="card-title">Modified Balance</h5>
                                <p class="card-text text-muted">Adjust wallet balance to match actual amount</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction History Section (Hidden by default) -->
            <div id="transactionHistorySection" style="display: none;">
                <!-- Mobile Header with Wallet Selector and Search -->
                <div class="d-lg-none mb-3">
                    <div class="d-flex align-items-center p-3 bg-light rounded" style="margin-left: 3.5rem;">
                        <div class="wallet-selector flex-grow-1 me-3">
                            <select class="form-select form-select-sm" id="mobileWalletFilter" onchange="filterByWallet(this.value)">
                                <option value="">All Wallets</option>
                                    {% for wallet in wallets %}
                                <option value="{{ wallet._id }}" {% if current_wallet_id == wallet._id %}selected{% endif %}>
                                    {{ wallet.name }}
                                    </option>
                                    {% endfor %}
      </select>
                            </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-outline-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#searchFilterModal">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="hideTransactionHistory()">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            </div>
                        </div>
                            </div>

                <!-- Desktop Header -->
                <div class="d-none d-lg-flex justify-content-between align-items-center mb-4">
                    <h3 class="h4 mb-0">Transaction History</h3>
                    <button class="btn btn-outline-secondary" onclick="hideTransactionHistory()">
                        <i class="fas fa-arrow-left"></i> Back to Menu
                                </button>
            </div>







            <!-- Transactions List -->
            <div class="card content-card">
                <div class="card-body">
                    {% if transactions %}
                    <!-- Desktop Table View -->
                    <div class="table-responsive d-none d-lg-block">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Balance Before</th>
                                    <th>Balance After</th>
                                    <th>Category</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tx in transactions %}
                                <tr>
                                    <td>
                                        {% if tx.formatted_time and tx.formatted_time != 'N/A' %}
                                            {% set date_time_parts = tx.formatted_time.split(' ') %}
                                            {% if date_time_parts|length >= 2 %}
                                                <span class="badge bg-primary me-1">{{ date_time_parts[0] }}</span>
                                                <span class="badge bg-secondary">{{ date_time_parts[1] }}</span>
                                            {% else %}
                                                <span class="badge bg-primary">{{ tx.formatted_time }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-light text-dark">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if tx.is_balance_adjustment %}
                                        <span class="badge {% if tx.type == 'income' %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if tx.type == 'income' %}+{% else %}-{% endif %} {{ tx.type|title }}
                                        </span>
                                        <br><small class="text-muted" style="font-size: 0.7rem;">Balance Adjustment</small>
                                        {% else %}
                                        <span class="badge {% if tx.type == 'income' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ tx.type|title }}
                                        </span>
                                        {% endif %}
                                        <div class="mt-1">
                                            {% set scope = scopes|selectattr('_id', 'equalto', tx.scope_id)|first %}
                                            <small class="text-muted">{{ scope.name if scope else 'N/A' }}</small>
                                        </div>
                                    </td>
                                    <td class="fw-bold">
                                        {{ tx.amount|currency_decimal }}
                                        <div class="mt-1">
                                            {% set wallet = wallets|selectattr('_id', 'equalto', tx.wallet_id)|first %}
                                            <small class="text-muted">{{ wallet.name if wallet else 'N/A' }}{% if wallet %} ({{ wallet.type or 'bank' }}){% endif %}</small>
                                        </div>
                                    </td>
                                    <td class="text-muted">
                                        {% if tx.balance_before is defined and tx.balance_before is not none %}
                                            Rp {{ "{:,.0f}".format(tx.balance_before|float) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-medium">
                                        {% if tx.balance_after is defined and tx.balance_after is not none %}
                                            Rp {{ "{:,.0f}".format(tx.balance_after|float) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set category = categories|selectattr('_id', 'equalto', tx.category_id)|first %}
                                        <div>{{ category.name if category else 'N/A' }}</div>
                                        {% if tx.tags %}
                                            <div class="mt-1">
                                                {% for tag in tx.tags %}
                                                <span class="badge bg-secondary me-1" style="font-size: 0.65rem;">{{ tag }}</span>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <div class="mt-1">
                                                <small class="text-muted">No tags</small>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-info me-1" onclick="showTransactionDetails('{{ tx._id }}')" title="View Details">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editTransaction('{{ tx._id }}')" title="Edit Transaction">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('{{ tx._id }}')" title="Delete Transaction">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
      </table>
                    </div>
                    
                    <!-- Mobile Card View -->
                    <div class="d-lg-none">
                        {% for tx in transactions %}
                        <div class="card mb-3 transaction-card">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="transaction-icon me-3">
                                            {% if tx.is_balance_adjustment %}
                                            <i class="fas fa-balance-scale text-warning fa-lg"></i>
                                            {% else %}
                                            <i class="fas fa-{% if tx.type == 'income' %}arrow-up text-success{% elif tx.type == 'expense' %}arrow-down text-danger{% else %}exchange-alt text-info{% endif %} fa-lg"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h6 class="mb-1 transaction-type">
                                                {% if tx.is_balance_adjustment %}
                                                {% if tx.type == 'income' %}+{% else %}-{% endif %} {{ tx.type|title }}
                                                <br><small class="text-muted" style="font-size: 0.7rem;">Balance Adjustment</small>
                                                {% else %}
                                                {% set category = categories|selectattr('_id', 'equalto', tx.category_id)|first %}
                                                {{ category.name if category else tx.type|title }}
                                                {% endif %}
                                            </h6>
                                            <small class="text-muted">
                                                {% set wallet = wallets|selectattr('_id', 'equalto', tx.wallet_id)|first %}
                                                {{ wallet.name if wallet else 'Unknown Wallet' }}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="transaction-amount {% if tx.is_balance_adjustment %}text-warning{% elif tx.type == 'income' %}text-success{% elif tx.type == 'expense' %}text-danger{% else %}text-info{% endif %} fw-bold">
                                            {% if tx.is_balance_adjustment %}
                                                {% if tx.type == 'income' %}+{% else %}-{% endif %}Rp {{ tx.amount|currency }}
                                            {% else %}
                                                {% if tx.type == 'income' %}+{% elif tx.type == 'expense' %}-{% endif %}Rp {{ tx.amount|currency }}
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">{{ tx.formatted_time or 'N/A' }}</small>
                                    </div>
                                </div>
                                
                                {% if tx.note %}
                                <div class="transaction-note mb-2">
                                    <small class="text-muted">{{ tx.note }}</small>
                                </div>
                                {% endif %}
                                
                                <!-- Balance Information -->
                                {% if tx.balance_before is defined and tx.balance_after is defined and tx.balance_before is not none and tx.balance_after is not none %}
                                <div class="balance-info mb-2 p-2 bg-light rounded">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="small text-muted">Balance Before</div>
                                            <div class="fw-medium">Rp {{ "{:,.0f}".format(tx.balance_before|float) }}</div>
                                        </div>
                                        <div class="col-6">
                                            <div class="small text-muted">Balance After</div>
                                            <div class="fw-bold text-primary">Rp {{ "{:,.0f}".format(tx.balance_after|float) }}</div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if tx.is_transfer or tx.type == 'transfer' %}
                                <div class="transfer-details mb-2 p-2 bg-light rounded">
                                    <div class="small">
                                        <div><strong>From:</strong> 
                                            {% set from_wallet = wallets|selectattr('_id', 'equalto', tx.from_wallet_id)|first %}
                                            {{ from_wallet.name if from_wallet else 'N/A' }}
                                        </div>
                                        <div><strong>To:</strong> 
                                            {% set to_wallet = wallets|selectattr('_id', 'equalto', tx.to_wallet_id)|first %}
                                            {{ to_wallet.name if to_wallet else 'N/A' }}
                                        </div>
                                        {% if tx.admin_fee %}
                                        <div class="text-danger"><strong>Fee:</strong> Rp {{ tx.admin_fee|currency }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% elif tx.is_transfer_fee %}
                                <div class="transfer-details mb-2 p-2 bg-light rounded">
                                    <div class="small">
                                        <div class="text-danger"><strong>Transfer Fee</strong></div>
                                        <div><strong>From:</strong> 
                                            {% set from_wallet = wallets|selectattr('_id', 'equalto', tx.from_wallet_id)|first %}
                                            {{ from_wallet.name if from_wallet else 'N/A' }}
                                        </div>
                                        <div><strong>To:</strong> 
                                            {% set to_wallet = wallets|selectattr('_id', 'equalto', tx.to_wallet_id)|first %}
                                            {{ to_wallet.name if to_wallet else 'N/A' }}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if tx.tags %}
                                <div class="transaction-tags mb-2">
                                    {% for tag in tx.tags %}
                                    <span class="badge bg-secondary me-1" style="font-size: 0.7rem;">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="transaction-actions">
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editTransaction('{{ tx._id }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('{{ tx._id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="transaction-id">
                                        <small class="text-muted">ID: {{ tx._id[:8] }}...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No transactions found</h5>
                        <p class="text-muted">Try adjusting your filters or add a new transaction.</p>
                    </div>
                    {% endif %}
                </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Progress Bar -->
                <div class="progress mb-4" style="height: 8px;">
                    <div class="progress-bar" id="transactionProgress" role="progressbar" style="width: 16.66%"></div>
                </div>
                
                <!-- Step 1: Scope Selection -->
                <div id="step1" class="step-content">
                    <div class="text-center mb-4">
                        <i class="fas fa-folder-open fa-3x text-primary mb-3"></i>
                        <h4>Select Scope</h4>
                        <p class="text-muted">Choose the scope for this transaction</p>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <select class="form-select form-select-lg" id="add_scope_id" name="scope_id" required>
                                <option value="">Select Scope</option>
                                {% for scope in scopes %}
                                <option value="{{ scope._id }}">{{ scope.name }}</option>
                                {% endfor %}
                            </select>
                            <!-- Debug: Show scope count -->
                            <div class="mt-2">
                                <small class="text-muted">Debug: Found {{ scopes|length }} scopes</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Saving Space Selection -->
                <div id="step2" class="step-content" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="fas fa-wallet fa-3x text-success mb-3"></i>
                        <h4>Select Saving Space</h4>
                        <p class="text-muted">Choose which wallet this transaction affects</p>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <select class="form-select form-select-lg" id="add_wallet_id" name="wallet_id" required>
                                <option value="">Select Saving Space</option>
                                {% for wallet in wallets %}
                                {% if wallet.actual_balance and wallet.actual_balance > 0 %}
                                <option value="{{ wallet._id }}">{{ wallet.name }} ({{ wallet.type or 'bank' }}) - Balance: IDR {{ "{:,.0f}".format(wallet.actual_balance) }}</option>
                                {% else %}
                                <option value="{{ wallet._id }}" disabled>{{ wallet.name }} ({{ wallet.type or 'bank' }}) - Balance: IDR 0 (Add balance first)</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                            <div class="mt-2 text-center">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Wallets with 0 balance are disabled. 
                                    <a href="/balance" class="text-primary">Go to Balance page</a> to add funds.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Transaction Type -->
                <div id="step3" class="step-content" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="fas fa-exchange-alt fa-3x text-info mb-3"></i>
                        <h4>Transaction Type</h4>
                        <p class="text-muted">Is this income or expense?</p>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="d-grid gap-3">
                                <button type="button" class="btn btn-outline-success btn-lg" onclick="selectTransactionType('income')">
                                    <i class="fas fa-plus-circle me-2"></i>Income
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-lg" onclick="selectTransactionType('expense')">
                                    <i class="fas fa-minus-circle me-2"></i>Expense
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Category and Tags -->
                <div id="step4" class="step-content" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="fas fa-tags fa-3x text-warning mb-3"></i>
                        <h4>Category & Tags</h4>
                        <p class="text-muted">Categorize and tag your transaction</p>
                        <small class="text-info">
                            <i class="fas fa-info-circle me-1"></i>
                            Sequence number will be automatically assigned based on the latest manual balance
                        </small>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add_category_id" class="form-label">Category</label>
                            <select class="form-select" id="add_category_id" name="category_id">
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                {% if category.name == "Transfer" or category.name == "Balance Adjustment" %}
                                <option value="{{ category._id }}" disabled>{{ category.name }} (by system only)</option>
                                {% else %}
                                <option value="{{ category._id }}">{{ category.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="add_tags" class="form-label">Tags (comma separated)</label>
                            <input type="text" class="form-control" id="add_tags" name="tags" placeholder="food, entertainment, work">
                        </div>
                    </div>
                </div>

                <!-- Step 5: Amount -->
                <div id="step5" class="step-content" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="fas fa-money-bill-wave fa-3x text-success mb-3"></i>
                        <h4>Transaction Amount</h4>
                        <p class="text-muted">Enter the amount for this transaction</p>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <!-- Balance Information -->
                            <div class="alert alert-info mb-3" id="balanceInfo" style="display: none;">
                                <i class="fas fa-wallet me-2"></i>
                                <strong>Available Balance:</strong> <span id="availableBalance">IDR 0</span>
                                <br>
                                <small class="text-muted">For expense transactions, amount cannot exceed available balance</small>
                            </div>
                            
                            <!-- Balance Warning (Red) -->
                            <div class="alert alert-danger mb-3" id="balanceWarning" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Insufficient Balance!</strong>
                                <br>
                                <span id="balanceWarningText">Amount exceeds available balance</span>
                            </div>
                            
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">IDR</span>
                                <input type="text" class="form-control form-control-lg text-center" id="add_amount" name="amount" required placeholder="1.000.000">
                            </div>
                            <small class="form-text text-muted">Format: 1.000.000 (gunakan titik sebagai separator ribuan)</small>
                        </div>
                    </div>
                </div>

                <!-- Step 6: Date Confirmation -->
                <div id="step6" class="step-content" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="fas fa-calendar-check fa-3x text-primary mb-3"></i>
                        <h4>Date Confirmation</h4>
                        <p class="text-muted">Just to make sure, this transaction happened recently, right?</p>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="d-grid gap-3">
                                <button type="button" class="btn btn-outline-primary btn-lg" onclick="confirmRecentTransaction()">
                                    <i class="fas fa-check me-2"></i>Yes, it's recent
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="showDatePicker()">
                                    <i class="fas fa-calendar me-2"></i>No, pick different date
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 7: Note and Submit -->
                <div id="step7" class="step-content" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="fas fa-sticky-note fa-3x text-info mb-3"></i>
                        <h4>Final Note</h4>
                        <p class="text-muted">Add any additional notes (optional)</p>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <textarea class="form-control" id="add_note" name="note" rows="4" placeholder="Add any notes about this transaction..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Hidden form for submission -->
                <form id="addTransactionForm" style="display: none;">
                    <input type="hidden" id="add_type" name="type">
                    <input type="hidden" id="add_timestamp" name="timestamp">
                </form>
            </div>
            <div class="modal-footer">
                <!-- Selection Summary -->
                <div id="selectionSummary" class="alert alert-info mb-3 w-100" style="display: none;">
                    <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Selected Options:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div id="summaryScope" class="mb-1" style="display: none;">
                                <strong>Scope:</strong> <span id="summaryScopeValue">-</span>
                            </div>
                            <div id="summaryWallet" class="mb-1" style="display: none;">
                                <strong>Saving Space:</strong> <span id="summaryWalletValue">-</span>
                            </div>
                            <div id="summaryType" class="mb-1" style="display: none;">
                                <strong>Type:</strong> <span id="summaryTypeValue">-</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="summaryCategory" class="mb-1" style="display: none;">
                                <strong>Category:</strong> <span id="summaryCategoryValue">-</span>
                            </div>
                            <div id="summaryTags" class="mb-1" style="display: none;">
                                <strong>Tags:</strong> <span id="summaryTagsValue">-</span>
                            </div>
                            <div id="summaryAmount" class="mb-1" style="display: none;">
                                <strong>Amount:</strong> <span id="summaryAmountValue">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">
                        <i class="fas fa-arrow-left me-1"></i>Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                        Next<i class="fas fa-arrow-right ms-1"></i>
                    </button>
                    <button type="button" class="btn btn-success" id="submitBtn" onclick="submitTransaction()" style="display: none;">
                        <i class="fas fa-check me-1"></i>Submit Transaction
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTransactionForm">
                    <input type="hidden" id="edit_id" name="_id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_amount" class="form-label">Amount *</label>
                            <input type="text" class="form-control" id="edit_amount" name="amount" required placeholder="1.000.000">
                            <small class="form-text text-muted">Format: 1.000.000 (gunakan titik sebagai separator ribuan)</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_type" class="form-label">Type *</label>
                            <select class="form-select" id="edit_type" name="type" required>
                                <option value="expense">Expense</option>
                                <option value="income">Income</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_category_id" class="form-label">Category</label>
                            <select class="form-select" id="edit_category_id" name="category_id">
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                {% if category.name == "Transfer" or category.name == "Balance Adjustment" %}
                                <option value="{{ category._id }}" disabled>{{ category.name }} (by system only)</option>
                                {% else %}
                                <option value="{{ category._id }}">{{ category.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_wallet_id" class="form-label">Saving Space</label>
                            <select class="form-select" id="edit_wallet_id" name="wallet_id">
                                <option value="">Select Saving Space</option>
                                {% for wallet in wallets %}
                                <option value="{{ wallet._id }}">{{ wallet.name }} ({{ wallet.type or 'bank' }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_scope_id" class="form-label">Scope</label>
                            <select class="form-select" id="edit_scope_id" name="scope_id">
                                <option value="">Select Scope</option>
                                {% for scope in scopes %}
                                <option value="{{ scope._id }}">{{ scope.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_timestamp" class="form-label">Date & Time</label>
                            <input type="datetime-local" class="form-control" id="edit_timestamp" name="timestamp">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_tags" class="form-label">Tags (comma separated)</label>
                        <input type="text" class="form-control" id="edit_tags" name="tags" placeholder="food, entertainment, work">
                    </div>
                    <div class="mb-3">
                        <label for="edit_note" class="form-label">Note</label>
                        <textarea class="form-control" id="edit_note" name="note" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateTransaction()">Update Transaction</button>
            </div>
        </div>
    </div>
  </div>

<script>
// Auto-submit form when filter changes
document.addEventListener('DOMContentLoaded', function() {
    const filterSelects = ['scope_id', 'category_id', 'wallet_id', 'type'];
    filterSelects.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', function() {
                document.getElementById('filterForm').submit();
            });
        }
    });
    
    // Set default datetime to today for add transaction form
    setDefaultDateTime();
    
    // Setup amount formatting for add and edit forms
    setupAmountFormatting();
    
    // Setup wallet selection listener for balance info
    setupWalletSelectionListener();
});

// Set default datetime to today
function setDefaultDateTime() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    
    const defaultDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
    
    const addTimestampField = document.getElementById('add_timestamp');
    if (addTimestampField) {
        addTimestampField.value = defaultDateTime;
    }
}

// Setup amount formatting with thousand separators
function setupAmountFormatting() {
    // Add transaction form
    const addAmountField = document.getElementById('add_amount');
    if (addAmountField) {
        addAmountField.addEventListener('input', function(e) {
            formatAmountInput(e.target);
        });
    }
    
    // Edit transaction form
    const editAmountField = document.getElementById('edit_amount');
    if (editAmountField) {
        editAmountField.addEventListener('input', function(e) {
            formatAmountInput(e.target);
        });
    }
}

// Setup wallet selection listener for balance info
function setupWalletSelectionListener() {
    const addWalletField = document.getElementById('add_wallet_id');
    if (addWalletField) {
        addWalletField.addEventListener('change', function() {
            // Update selection summary
            updateSelectionSummary();
            // Update balance info if we're on step 5
            if (currentStep === 5) {
                updateBalanceInfo();
                validateAmountInRealTime();
            }
        });
    }
    
    // Setup scope selection listener
    const addScopeField = document.getElementById('add_scope_id');
    if (addScopeField) {
        addScopeField.addEventListener('change', function() {
            updateSelectionSummary();
        });
    }
    
    // Setup category selection listener
    const addCategoryField = document.getElementById('add_category_id');
    if (addCategoryField) {
        addCategoryField.addEventListener('change', function() {
            updateSelectionSummary();
        });
    }
    
    // Setup tags input listener
    const addTagsField = document.getElementById('add_tags');
    if (addTagsField) {
        addTagsField.addEventListener('input', function() {
            updateSelectionSummary();
        });
    }
    
    // Setup amount input listener for real-time validation
    const addAmountField = document.getElementById('add_amount');
    if (addAmountField) {
        addAmountField.addEventListener('input', function() {
            if (currentStep === 5) {
                validateAmountInRealTime();
            }
        });
    }
}

// Format amount input with thousand separators
function formatAmountInput(input) {
    let value = input.value.replace(/[^\d]/g, ''); // Remove non-digits
    
    if (value === '') return;
    
    // Convert to number and format with thousand separators
    const number = parseInt(value);
    const formatted = number.toLocaleString('id-ID');
    
    input.value = formatted;
}

// Parse amount from formatted string (e.g., "1.000.000" -> 1000000)
function parseFormattedAmount(amountString) {
    if (!amountString) return 0;
    return parseInt(amountString.replace(/\./g, '')) || 0;
}

function editTransaction(transactionId) {
    fetch(`/api/transactions/${transactionId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit_id').value = data._id;
            // Format amount with thousand separators
        const formattedAmount = parseInt(data.amount).toLocaleString('id-ID');
        document.getElementById('edit_amount').value = formattedAmount;
            document.getElementById('edit_type').value = data.type;
            document.getElementById('edit_category_id').value = data.category_id || '';
            document.getElementById('edit_wallet_id').value = data.wallet_id || '';
            document.getElementById('edit_scope_id').value = data.scope_id || '';
            document.getElementById('edit_tags').value = Array.isArray(data.tags) ? data.tags.join(', ') : '';
            document.getElementById('edit_note').value = data.note || '';
            
            // Convert timestamp to datetime-local format (using local timezone)
            if (data.timestamp) {
                const date = new Date(data.timestamp * 1000);
                // Format as YYYY-MM-DDTHH:MM:SS using local timezone
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
                document.getElementById('edit_timestamp').value = localDateTime;
            }
            
            new bootstrap.Modal(document.getElementById('editModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load transaction data');
        });
}

function closeEditModal() {
    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
}

function updateTransaction() {
    const form = document.getElementById('editTransactionForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Parse amount from formatted string (e.g., "1.000.000" -> 1000000)
    if (data.amount) {
        data.amount = parseFormattedAmount(data.amount);
    }
    
    // Convert tags string to array
    if (data.tags) {
        data.tags = data.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
    }
    
    // Convert datetime-local to timestamp
    if (data.timestamp) {
        data.timestamp = Math.floor(new Date(data.timestamp).getTime() / 1000);
    }
    
    const transactionId = data._id;
    delete data._id;
    
        // Show loading state
        const submitButton = document.querySelector('#editModal .btn-primary');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Updating...';
        submitButton.disabled = true;
        
        fetch(`/api/transactions/${transactionId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                // Show balance recalculation loading
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Recalculating balances...';
                
                // Wait a moment to show the loading state, then proceed
                setTimeout(() => {
                    alert('Transaction updated and balances recalculated successfully!');
                    closeEditModal();
                    location.reload();
                }, 1000);
            } else {
                throw new Error('Failed to update transaction');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update transaction');
            closeEditModal();
            location.reload();
        })
        .finally(() => {
            // Restore button state
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        });
}

function deleteTransaction(transactionId) {
    if (confirm('Are you sure you want to delete this transaction?')) {
        fetch(`/api/transactions/${transactionId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Transaction deleted successfully!');
                location.reload();
            } else {
                alert('Failed to delete transaction');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete transaction');
        });
    }
}

function submitTransaction() {
    // Collect data from all visible form elements
    const data = {
        scope_id: document.getElementById('add_scope_id').value,
        wallet_id: document.getElementById('add_wallet_id').value,
        type: document.getElementById('add_type').value,
        category_id: document.getElementById('add_category_id').value,
        tags: document.getElementById('add_tags').value,
        amount: document.getElementById('add_amount').value,
        note: document.getElementById('add_note').value,
        timestamp: document.getElementById('add_timestamp').value
    };
    
    // Parse amount from formatted string (e.g., "1.000.000" -> 1000000)
    if (data.amount) {
        data.amount = parseFormattedAmount(data.amount);
    }
    
    // Convert tags string to array
    if (data.tags) {
        data.tags = data.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
    }
    
    // Validate timestamp
    if (!data.timestamp) {
        alert('Timestamp is missing. Please go back and confirm the date.');
        return;
    }
    
    // Ensure timestamp is a number
    data.timestamp = parseInt(data.timestamp);
    
    // Debug logging
    console.log('Submitting transaction data:', data);
    console.log('Timestamp value:', data.timestamp, 'Type:', typeof data.timestamp);
    console.log('Date from timestamp:', new Date(data.timestamp * 1000));
    console.log('Wallet ID:', data.wallet_id);
    console.log('User ID will be set by backend');
    console.log('Manual Balance ID and Sequence Number will be auto-populated by backend');
    
    fetch('/api/transactions/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data._id) {
            alert('Transaction added successfully!');
            bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
            location.reload();
        } else {
            alert('Failed to add transaction');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add transaction');
    });
}

function exportTransactions() {
    // Get current filter parameters
    const urlParams = new URLSearchParams(window.location.search);
    const filters = {};
    
    for (const [key, value] of urlParams) {
        if (key === 'tags') {
            if (!filters[key]) filters[key] = [];
            filters[key].push(value);
        } else {
            filters[key] = value;
        }
    }
    
    // Create export URL
    const exportUrl = `/api/transactions/export?${urlParams.toString()}`;
    
    // Download file
    const link = document.createElement('a');
    link.href = exportUrl;
    link.download = 'transactions.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// New functions for improved UI/UX
let currentStep = 1;
const totalSteps = 7;

function showAddTransaction() {
    // Reset to first step
    currentStep = 1;
    resetTransactionForm();
    
    // Show the add transaction modal
    const modal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
    modal.show();
    
    // Update progress bar
    updateProgressBar();
    
    // Debug: check if timestamp field is reset
    console.log('Form reset - Timestamp field value:', document.getElementById('add_timestamp').value);
}

function nextStep() {
    if (currentStep < totalSteps) {
        // Validate current step
        if (validateCurrentStep()) {
            currentStep++;
            showStep(currentStep);
            updateProgressBar();
            updateButtons();
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        updateProgressBar();
        updateButtons();
    }
}

function showStep(stepNumber) {
    // Hide all steps
    for (let i = 1; i <= totalSteps; i++) {
        const stepElement = document.getElementById(`step${i}`);
        if (stepElement) {
            stepElement.style.display = 'none';
        }
    }
    
    // Show current step
    const currentStepElement = document.getElementById(`step${stepNumber}`);
    if (currentStepElement) {
        currentStepElement.style.display = 'block';
    }
    
    // Update modal title
    const modalTitle = document.querySelector('#addTransactionModal .modal-title');
    if (modalTitle) {
        const stepTitles = [
            'Step 1: Select Scope',
            'Step 2: Select Saving Space', 
            'Step 3: Transaction Type',
            'Step 4: Category & Tags',
            'Step 5: Transaction Amount',
            'Step 6: Date Confirmation',
            'Step 7: Final Note'
        ];
        modalTitle.textContent = stepTitles[stepNumber - 1];
    }
    
    // Update selection summary
    updateSelectionSummary();
    
    // Special handling for step 5: show balance info and validate amount
    if (stepNumber === 5) {
        updateBalanceInfo();
        validateAmountInRealTime();
    }
}

function updateProgressBar() {
    const progress = (currentStep / totalSteps) * 100;
    const progressBar = document.getElementById('transactionProgress');
    if (progressBar) {
        progressBar.style.width = progress + '%';
    }
}

function updateButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    if (prevBtn) prevBtn.style.display = currentStep > 1 ? 'inline-block' : 'none';
    if (nextBtn) nextBtn.style.display = currentStep < totalSteps ? 'inline-block' : 'none';
    if (submitBtn) submitBtn.style.display = currentStep === totalSteps ? 'inline-block' : 'none';
}

function validateCurrentStep() {
    switch (currentStep) {
        case 1:
            const scopeId = document.getElementById('add_scope_id').value;
            if (!scopeId) {
                alert('Please select a scope');
                return false;
            }
            break;
        case 2:
            const walletId = document.getElementById('add_wallet_id').value;
            if (!walletId) {
                alert('Please select a saving space');
                return false;
            }
            // Check if selected wallet has balance > 0
            const selectedOption = document.querySelector(`#add_wallet_id option[value="${walletId}"]`);
            if (selectedOption && selectedOption.disabled) {
                alert('This wallet has 0 balance. Please go to Balance page to add funds first.');
                return false;
            }
            break;
        case 3:
            const type = document.getElementById('add_type').value;
            if (!type) {
                alert('Please select transaction type');
                return false;
            }
            break;
        case 4:
            // Category and tags are optional
            break;
        case 5:
            const amount = document.getElementById('add_amount').value;
            if (!amount) {
                alert('Please enter transaction amount');
                return false;
            }
            
            // Check if amount exceeds wallet balance for expense transactions
            const transactionType = document.getElementById('add_type').value;
            if (transactionType === 'expense') {
                const walletId = document.getElementById('add_wallet_id').value;
                const selectedWalletOption = document.querySelector(`#add_wallet_id option[value="${walletId}"]`);
                
                if (selectedWalletOption) {
                    // Extract balance from option text (format: "Wallet Name (type) - Balance: IDR 1,000,000")
                    const balanceText = selectedWalletOption.textContent;
                    const balanceMatch = balanceText.match(/Balance: IDR ([\d,]+)/);
                    
                    if (balanceMatch) {
                        const currentBalance = parseInt(balanceMatch[1].replace(/,/g, ''));
                        const transactionAmount = parseFormattedAmount(amount);
                        
                        if (transactionAmount > currentBalance) {
                            // Don't show alert, just return false (red warning already visible)
                            return false;
                        }
                    }
                }
            }
            break;
        case 6:
            // Date confirmation handled by buttons
            const timestamp = document.getElementById('add_timestamp').value;
            if (!timestamp) {
                alert('Please confirm the transaction date first');
                return false;
            }
            break;
        case 7:
            // Note is optional
            break;
    }
    return true;
}

function selectTransactionType(type) {
    document.getElementById('add_type').value = type;
    updateSelectionSummary();
    nextStep();
}

function updateBalanceInfo() {
    const walletId = document.getElementById('add_wallet_id').value;
    const balanceInfo = document.getElementById('balanceInfo');
    const availableBalanceSpan = document.getElementById('availableBalance');
    
    if (walletId) {
        const selectedWalletOption = document.querySelector(`#add_wallet_id option[value="${walletId}"]`);
        if (selectedWalletOption && !selectedWalletOption.disabled) {
            // Extract balance from option text (format: "Wallet Name (type) - Balance: IDR 1,000,000")
            const balanceText = selectedWalletOption.textContent;
            const balanceMatch = balanceText.match(/Balance: IDR ([\d,]+)/);
            
            if (balanceMatch) {
                const currentBalance = parseInt(balanceMatch[1].replace(/,/g, ''));
                availableBalanceSpan.textContent = `IDR ${currentBalance.toLocaleString('id-ID')}`;
                balanceInfo.style.display = 'block';
            }
        } else {
            balanceInfo.style.display = 'none';
        }
    } else {
        balanceInfo.style.display = 'none';
    }
}

function validateAmountInRealTime() {
    const transactionType = document.getElementById('add_type').value;
    const amount = document.getElementById('add_amount').value;
    const balanceInfo = document.getElementById('balanceInfo');
    const balanceWarning = document.getElementById('balanceWarning');
    const balanceWarningText = document.getElementById('balanceWarningText');
    
    // Hide both alerts initially
    balanceInfo.style.display = 'none';
    balanceWarning.style.display = 'none';
    
    // Update selection summary when amount changes
    updateSelectionSummary();
    
    // Only validate for expense transactions
    if (transactionType === 'expense' && amount) {
        const walletId = document.getElementById('add_wallet_id').value;
        const selectedWalletOption = document.querySelector(`#add_wallet_id option[value="${walletId}"]`);
        
        if (selectedWalletOption && !selectedWalletOption.disabled) {
            // Extract balance from option text
            const balanceText = selectedWalletOption.textContent;
            const balanceMatch = balanceText.match(/Balance: IDR ([\d,]+)/);
            
            if (balanceMatch) {
                const currentBalance = parseInt(balanceMatch[1].replace(/,/g, ''));
                const transactionAmount = parseFormattedAmount(amount);
                
                if (transactionAmount > currentBalance) {
                    // Show red warning
                    balanceWarningText.textContent = `Amount (IDR ${transactionAmount.toLocaleString('id-ID')}) exceeds available balance (IDR ${currentBalance.toLocaleString('id-ID')})`;
                    balanceWarning.style.display = 'block';
                } else {
                    // Show blue info
                    balanceInfo.style.display = 'block';
                }
            }
        }
    } else if (transactionType === 'expense') {
        // Show blue info for expense transactions without amount
        balanceInfo.style.display = 'block';
    }
}

// Update selection summary display
function updateSelectionSummary() {
    const summaryDiv = document.getElementById('selectionSummary');
    const scopeDiv = document.getElementById('summaryScope');
    const walletDiv = document.getElementById('summaryWallet');
    const typeDiv = document.getElementById('summaryType');
    const categoryDiv = document.getElementById('summaryCategory');
    const tagsDiv = document.getElementById('summaryTags');
    const amountDiv = document.getElementById('summaryAmount');
    
    const scopeValue = document.getElementById('summaryScopeValue');
    const walletValue = document.getElementById('summaryWalletValue');
    const typeValue = document.getElementById('summaryTypeValue');
    const categoryValue = document.getElementById('summaryCategoryValue');
    const tagsValue = document.getElementById('summaryTagsValue');
    const amountValue = document.getElementById('summaryAmountValue');
    
    let hasAnySelection = false;
    
    // Update scope
    const selectedScopeId = document.getElementById('add_scope_id').value;
    if (selectedScopeId) {
        const selectedScopeOption = document.querySelector(`#add_scope_id option[value="${selectedScopeId}"]`);
        if (selectedScopeOption) {
            scopeValue.textContent = selectedScopeOption.textContent;
            scopeDiv.style.display = 'block';
            hasAnySelection = true;
        }
    } else {
        scopeDiv.style.display = 'none';
    }
    
    // Update wallet
    const selectedWalletId = document.getElementById('add_wallet_id').value;
    if (selectedWalletId) {
        const selectedWalletOption = document.querySelector(`#add_wallet_id option[value="${selectedWalletId}"]`);
        if (selectedWalletOption) {
            // Extract just the wallet name and type from the option text
            const walletText = selectedWalletOption.textContent;
            const walletName = walletText.split(' - Balance:')[0]; // Remove balance info
            walletValue.textContent = walletName;
            walletDiv.style.display = 'block';
            hasAnySelection = true;
        }
    } else {
        walletDiv.style.display = 'none';
    }
    
    // Update type
    const selectedType = document.getElementById('add_type').value;
    if (selectedType) {
        typeValue.textContent = selectedType.charAt(0).toUpperCase() + selectedType.slice(1);
        typeDiv.style.display = 'block';
        hasAnySelection = true;
    } else {
        typeDiv.style.display = 'none';
    }
    
    // Update category
    const selectedCategoryId = document.getElementById('add_category_id').value;
    if (selectedCategoryId) {
        const selectedCategoryOption = document.querySelector(`#add_category_id option[value="${selectedCategoryId}"]`);
        if (selectedCategoryOption) {
            categoryValue.textContent = selectedCategoryOption.textContent;
            categoryDiv.style.display = 'block';
            hasAnySelection = true;
        }
    } else {
        categoryDiv.style.display = 'none';
    }
    
    // Update tags
    const tags = document.getElementById('add_tags').value;
    if (tags && tags.trim()) {
        tagsValue.textContent = tags.trim();
        tagsDiv.style.display = 'block';
        hasAnySelection = true;
    } else {
        tagsDiv.style.display = 'none';
    }
    
    // Update amount
    const amount = document.getElementById('add_amount').value;
    if (amount) {
        amountValue.textContent = `IDR ${amount}`;
        amountDiv.style.display = 'block';
        hasAnySelection = true;
    } else {
        amountDiv.style.display = 'none';
    }
    
    // Show/hide summary based on whether there are any selections
    if (hasAnySelection) {
        summaryDiv.style.display = 'block';
    } else {
        summaryDiv.style.display = 'none';
    }
}

function confirmRecentTransaction() {
    // Set current timestamp
    const now = new Date();
    const timestamp = Math.floor(now.getTime() / 1000);
    
    // Set to hidden field
    document.getElementById('add_timestamp').value = timestamp;
    
    // Also set to a visible field for debugging (optional)
    console.log('Timestamp set to:', timestamp, 'Date:', new Date(timestamp * 1000));
    
    nextStep();
}

function showDatePicker() {
    // Show date picker modal or input
    const dateInput = document.createElement('input');
    dateInput.type = 'datetime-local';
    dateInput.className = 'form-control form-control-lg';
    dateInput.id = 'custom_timestamp';
    
    // Replace the buttons with date input
    const step6 = document.getElementById('step6');
    step6.innerHTML = `
        <div class="text-center mb-4">
            <i class="fas fa-calendar fa-3x text-primary mb-3"></i>
            <h4>Select Date & Time</h4>
            <p class="text-muted">Choose when this transaction occurred</p>
        </div>
        <div class="row justify-content-center">
            <div class="col-md-8">
                <input type="datetime-local" class="form-control form-control-lg" id="custom_timestamp" required>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary btn-lg" onclick="confirmCustomDate()">
                        <i class="fas fa-check me-2"></i>Confirm Date
                    </button>
                </div>
            </div>
        </div>
    `;
}

function confirmCustomDate() {
    const customDate = document.getElementById('custom_timestamp').value;
    if (customDate) {
        const timestamp = Math.floor(new Date(customDate).getTime() / 1000);
        document.getElementById('add_timestamp').value = timestamp;
        nextStep();
    } else {
        alert('Please select a date and time');
    }
}

function resetTransactionForm() {
    // Reset all form fields
    document.getElementById('add_scope_id').value = '';
    document.getElementById('add_wallet_id').value = '';
    document.getElementById('add_type').value = '';
    document.getElementById('add_category_id').value = '';
    document.getElementById('add_tags').value = '';
    document.getElementById('add_amount').value = '';
    document.getElementById('add_note').value = '';
    document.getElementById('add_timestamp').value = '';
    
    // Reset to first step
    showStep(1);
    updateButtons();
}

function showTransactionHistory() {
    // Hide the main menu and show transaction history
    document.querySelector('.text-center.mb-5').style.display = 'none';
    document.getElementById('transactionHistorySection').style.display = 'block';
}

function hideTransactionHistory() {
    // Show the main menu and hide transaction history
    document.querySelector('.text-center.mb-5').style.display = 'block';
    document.getElementById('transactionHistorySection').style.display = 'none';
}

// Auto-show transaction history if there are filters applied
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const hasFilters = Array.from(urlParams.keys()).some(key => 
        key !== '' && urlParams.get(key) !== '' && urlParams.get(key) !== null
    );
    
    if (hasFilters) {
        showTransactionHistory();
    }
});

// Filter by wallet function
function filterByWallet(walletId) {
    const url = new URL(window.location);
    if (walletId) {
        url.searchParams.set('wallet_id', walletId);
    } else {
        url.searchParams.delete('wallet_id');
    }
    window.location.href = url.toString();
}

// Apply filters from modal
function applyFilters() {
    const form = document.getElementById('modalFilterForm');
    form.submit();
}

// Clear all filters
function clearFilters() {
    window.location.href = '/transactions';
}

// Modified Balance Functions
function showModifiedBalance() {
    // Reset form
    document.getElementById('modify_wallet_id').value = '';
    document.getElementById('modify_amount').value = '';
    document.getElementById('balanceDifferenceInfo').style.display = 'none';
    document.getElementById('currentBalanceDisplay').style.display = 'none';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('modifiedBalanceModal'));
    modal.show();
}

function submitModifiedBalance() {
    const walletId = document.getElementById('modify_wallet_id').value;
    const amount = document.getElementById('modify_amount').value;
    
    if (!walletId) {
        alert('Please select a saving space');
        return;
    }
    
    if (!amount) {
        alert('Please enter the new balance amount');
        return;
    }
    
    // Parse amount from formatted string
    const newBalance = parseFormattedAmount(amount);
    
    // Get current balance from selected option
    const selectedOption = document.querySelector(`#modify_wallet_id option[value="${walletId}"]`);
    const currentBalance = parseFloat(selectedOption.getAttribute('data-balance')) || 0;
    
    // Calculate difference
    const difference = newBalance - currentBalance;
    
    if (difference === 0) {
        alert('The new balance is the same as current balance. No changes needed.');
        return;
    }
    
    // Prepare data
    const data = {
        wallet_id: walletId,
        new_balance: newBalance,
        current_balance: currentBalance,
        difference: difference,
        note: `Balance adjustment: ${difference > 0 ? 'Added' : 'Deducted'} IDR ${Math.abs(difference).toLocaleString('id-ID')} to match actual balance`
    };
    
    // Submit to API
    fetch('/api/transactions/modified-balance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Balance updated successfully!');
            bootstrap.Modal.getInstance(document.getElementById('modifiedBalanceModal')).hide();
            location.reload();
        } else {
            alert('Failed to update balance: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update balance');
    });
}

// Setup modified balance form listeners
document.addEventListener('DOMContentLoaded', function() {
    // Setup amount formatting for modified balance
    const modifyAmountField = document.getElementById('modify_amount');
    if (modifyAmountField) {
        modifyAmountField.addEventListener('input', function(e) {
            formatAmountInput(e.target);
            updateBalanceDifference();
        });
    }
    
    // Setup wallet selection listener
    const modifyWalletField = document.getElementById('modify_wallet_id');
    if (modifyWalletField) {
        modifyWalletField.addEventListener('change', function() {
            updateBalanceDifference();
        });
    }
    
    // Setup transfer form listeners
    const transferFromWallet = document.getElementById('transfer_from_wallet');
    const transferToWallet = document.getElementById('transfer_to_wallet');
    const transferAmount = document.getElementById('transfer_amount');
    const transferFee = document.getElementById('transfer_fee');
    
    console.log('Transfer elements found:');
    console.log('transferAmount:', transferAmount);
    console.log('transferFee:', transferFee);
    
    if (transferFromWallet) {
        transferFromWallet.addEventListener('change', function() {
            updateFromWalletBalance();
        });
    }
    if (transferAmount) {
        transferAmount.addEventListener('input', function(e) {
            console.log('Transfer amount input event triggered');
            formatAmountInput(e.target);
        });
    }
    if (transferFee) {
        transferFee.addEventListener('input', function(e) {
            console.log('Transfer fee input event triggered');
            formatAmountInput(e.target);
        });
    }
});

function updateBalanceDifference() {
    const walletId = document.getElementById('modify_wallet_id').value;
    const amount = document.getElementById('modify_amount').value;
    const differenceInfo = document.getElementById('balanceDifferenceInfo');
    const differenceAmount = document.getElementById('balanceDifferenceAmount');
    const currentBalanceDisplay = document.getElementById('currentBalanceDisplay');
    const currentBalanceAmount = document.getElementById('currentBalanceAmount');
    
    // Show/hide current balance display
    if (walletId) {
        const selectedOption = document.querySelector(`#modify_wallet_id option[value="${walletId}"]`);
        const currentBalance = parseFloat(selectedOption.getAttribute('data-balance')) || 0;
        
        // Show current balance
        currentBalanceAmount.textContent = `IDR ${currentBalance.toLocaleString('id-ID')}`;
        currentBalanceDisplay.style.display = 'block';
        
        // Calculate and show difference if amount is entered
        if (amount) {
            const newBalance = parseFormattedAmount(amount);
            const difference = newBalance - currentBalance;
            
            if (difference !== 0) {
                const differenceText = difference > 0 ? 
                    `+IDR ${difference.toLocaleString('id-ID')}` : 
                    `-IDR ${Math.abs(difference).toLocaleString('id-ID')}`;
                
                differenceAmount.textContent = differenceText;
                differenceInfo.style.display = 'block';
            } else {
                differenceInfo.style.display = 'none';
            }
        } else {
            differenceInfo.style.display = 'none';
        }
    } else {
        currentBalanceDisplay.style.display = 'none';
        differenceInfo.style.display = 'none';
    }
}

// Transfer Functions
function showTransfer() {
    console.log('showTransfer called');
    // Reset form
    document.getElementById('transfer_from_wallet').value = '';
    document.getElementById('transfer_to_wallet').value = '';
    document.getElementById('transfer_amount').value = '';
    document.getElementById('transfer_fee').value = '';
    document.getElementById('fromWalletBalanceDisplay').style.display = 'none';
    
    console.log('Form reset, displays hidden');
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('transferModal'));
    modal.show();
    console.log('Transfer modal shown');
}

function submitTransfer() {
    const fromWalletId = document.getElementById('transfer_from_wallet').value;
    const toWalletId = document.getElementById('transfer_to_wallet').value;
    const amount = document.getElementById('transfer_amount').value;
    const fee = document.getElementById('transfer_fee').value;
    
    if (!fromWalletId) {
        alert('Please select source wallet');
        return;
    }
    
    if (!toWalletId) {
        alert('Please select destination wallet');
        return;
    }
    
    if (fromWalletId === toWalletId) {
        alert('Source and destination wallets cannot be the same');
        return;
    }
    
    if (!amount) {
        alert('Please enter transfer amount');
        return;
    }
    
    // Parse amounts
    const transferAmount = parseFormattedAmount(amount);
    const adminFee = fee ? parseFormattedAmount(fee) : 0;
    const totalDeducted = transferAmount + adminFee;
    
    // Check if source wallet has sufficient balance
    const fromWalletOption = document.querySelector(`#transfer_from_wallet option[value="${fromWalletId}"]`);
    const fromWalletBalance = parseFloat(fromWalletOption.getAttribute('data-balance')) || 0;
    
    if (totalDeducted > fromWalletBalance) {
        alert(`Insufficient balance. Available: IDR ${fromWalletBalance.toLocaleString('id-ID')}, Required: IDR ${totalDeducted.toLocaleString('id-ID')}`);
        return;
    }
    
    // Prepare data
    const data = {
        from_wallet_id: fromWalletId,
        to_wallet_id: toWalletId,
        amount: transferAmount,
        admin_fee: adminFee
    };
    
    // Submit to API
    fetch('/api/transactions/transfer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Transfer completed successfully!');
            bootstrap.Modal.getInstance(document.getElementById('transferModal')).hide();
            location.reload();
        } else {
            alert('Failed to complete transfer: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to complete transfer');
    });
}

function updateFromWalletBalance() {
    console.log('updateFromWalletBalance called');
    const fromWalletId = document.getElementById('transfer_from_wallet').value;
    const display = document.getElementById('fromWalletBalanceDisplay');
    const balanceSpan = document.getElementById('fromWalletBalance');
    
    console.log('From wallet ID:', fromWalletId);
    console.log('Display element:', display);
    console.log('Balance span element:', balanceSpan);
    
    if (fromWalletId) {
        const selectedOption = document.querySelector(`#transfer_from_wallet option[value="${fromWalletId}"]`);
        if (selectedOption) {
            const balance = selectedOption.getAttribute('data-balance');
            console.log('Wallet balance:', balance);
            if (balance && balance !== '0') {
                const formattedBalance = parseFloat(balance).toLocaleString('id-ID');
                balanceSpan.textContent = `IDR ${formattedBalance}`;
                display.style.display = 'block';
                console.log('Balance display set to block with:', formattedBalance);
            } else {
                display.style.display = 'none';
                console.log('Balance display set to none (no balance)');
            }
        }
    } else {
        display.style.display = 'none';
        console.log('Balance display set to none (no wallet selected)');
    }
}

function showTransactionDetails(transactionId) {
    // Find the transaction data from the current page data
    const transaction = window.transactionData ? window.transactionData.find(tx => tx._id === transactionId) : null;
    
    if (!transaction) {
        // If not found in page data, fetch from API
        fetch(`/api/transactions/${transactionId}`)
            .then(response => response.json())
            .then(data => {
                displayTransactionDetails(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load transaction details');
            });
    } else {
        displayTransactionDetails(transaction);
    }
}

function displayTransactionDetails(tx) {
    const content = document.getElementById('transactionDetailsContent');
    
    // Build the details HTML
    let detailsHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-primary">Basic Information</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Date & Time:</strong></td>
                        <td>${tx.formatted_time || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Type:</strong></td>
                        <td>
                            <span class="badge ${tx.type === 'income' ? 'bg-success' : 'bg-danger'}">
                                ${tx.type ? tx.type.charAt(0).toUpperCase() + tx.type.slice(1) : 'N/A'}
                            </span>
                            ${tx.is_balance_adjustment ? '<br><small class="text-muted">Balance Adjustment</small>' : ''}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Amount:</strong></td>
                        <td class="fw-bold">${tx.amount ? 'Rp ' + parseFloat(tx.amount).toLocaleString('id-ID') : 'N/A'}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="text-primary">Balance Information</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Balance Before:</strong></td>
                        <td>${tx.balance_before ? 'Rp ' + parseFloat(tx.balance_before).toLocaleString('id-ID') : 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Balance After:</strong></td>
                        <td class="fw-bold">${tx.balance_after ? 'Rp ' + parseFloat(tx.balance_after).toLocaleString('id-ID') : 'N/A'}</td>
                    </tr>
                </table>
            </div>
        </div>
    `;
    
    // Add note if exists
    if (tx.note) {
        detailsHTML += `
            <div class="mt-3">
                <h6 class="text-primary">Note</h6>
                <div class="alert alert-light">
                    <i class="fas fa-sticky-note me-2"></i>${tx.note}
                </div>
            </div>
        `;
    }
    
    // Add transfer details if it's a transfer
    if (tx.is_transfer || tx.type === 'transfer') {
        detailsHTML += `
            <div class="mt-3">
                <h6 class="text-primary">Transfer Details</h6>
                <div class="alert alert-info">
                    <div><strong>From:</strong> ${tx.from_wallet_name || 'N/A'}</div>
                    <div><strong>To:</strong> ${tx.to_wallet_name || 'N/A'}</div>
                    ${tx.admin_fee ? `<div class="text-danger"><strong>Fee:</strong> Rp ${parseFloat(tx.admin_fee).toLocaleString('id-ID')}</div>` : ''}
                </div>
            </div>
        `;
    } else if (tx.is_transfer_fee) {
        detailsHTML += `
            <div class="mt-3">
                <h6 class="text-primary">Transfer Fee Details</h6>
                <div class="alert alert-warning">
                    <div class="text-danger"><strong>Transfer Fee</strong></div>
                    <div><strong>From:</strong> ${tx.from_wallet_name || 'N/A'}</div>
                    <div><strong>To:</strong> ${tx.to_wallet_name || 'N/A'}</div>
                </div>
            </div>
        `;
    }
    
    // Add tags if exist
    if (tx.tags && tx.tags.length > 0) {
        const tagsHTML = tx.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('');
        detailsHTML += `
            <div class="mt-3">
                <h6 class="text-primary">Tags</h6>
                <div>${tagsHTML}</div>
            </div>
        `;
    }
    
    content.innerHTML = detailsHTML;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('transactionDetailsModal'));
    modal.show();
}


</script>

<!-- Modified Balance Modal -->
<div class="modal fade" id="modifiedBalanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-balance-scale me-2"></i>Modified Balance
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-balance-scale fa-3x text-warning mb-3"></i>
                    <h4>Adjust Wallet Balance</h4>
                    <p class="text-muted">Set the actual balance of your wallet. The difference will be recorded as a transaction.</p>
                </div>
                
                <form id="modifiedBalanceForm">
                    <div class="row justify-content-center">
                        <div class="col-md-8 mb-4">
                            <label for="modify_wallet_id" class="form-label">Select Saving Space</label>
                            <select class="form-select form-select-lg" id="modify_wallet_id" name="wallet_id" required>
                                <option value="">Select Saving Space</option>
                                {% for wallet in wallets %}
                                <option value="{{ wallet._id }}" data-balance="{{ wallet.actual_balance or 0 }}">
                                    {{ wallet.name }} ({{ wallet.type or 'bank' }})
                                </option>
                                {% endfor %}
                            </select>
                            <!-- Current Balance Display -->
                            <div class="mt-2" id="currentBalanceDisplay" style="display: none;">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-wallet me-2"></i>
                                    <strong>Current Balance:</strong> <span id="currentBalanceAmount">IDR 0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row justify-content-center">
                        <div class="col-md-8 mb-4">
                            <label for="modify_amount" class="form-label">New Balance Amount</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">IDR</span>
                                <input type="text" class="form-control form-control-lg text-center" id="modify_amount" name="amount" required placeholder="1.000.000">
                            </div>
                            <small class="form-text text-muted">Format: 1.000.000 (gunakan titik sebagai separator ribuan)</small>
                        </div>
                    </div>
                    
                    <!-- Balance Difference Display -->
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="alert alert-info" id="balanceDifferenceInfo" style="display: none;">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Balance Difference:</strong> <span id="balanceDifferenceAmount">IDR 0</span>
                                <br>
                                <small class="text-muted">This amount will be recorded as a transaction</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitModifiedBalance()">
                    <i class="fas fa-balance-scale me-1"></i>Update Balance
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>Transfer Money
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-exchange-alt fa-3x text-info mb-3"></i>
                    <h4>Transfer Between Wallets</h4>
                    <p class="text-muted">Move money from one wallet to another with optional admin fee.</p>
                </div>
                
                <form id="transferForm">
                    <div class="row justify-content-center">
                        <div class="col-md-5 col-sm-6 mb-4">
                            <label for="transfer_from_wallet" class="form-label">From Wallet</label>
                            <select class="form-select form-select-lg" id="transfer_from_wallet" name="from_wallet_id" required>
                                <option value="">Select Source Wallet</option>
                                {% for wallet in wallets %}
                                {% if wallet.actual_balance and wallet.actual_balance > 0 %}
                                <option value="{{ wallet._id }}" data-balance="{{ wallet.actual_balance or 0 }}">
                                    {{ wallet.name }} ({{ wallet.type or 'bank' }})
                                </option>
                                {% else %}
                                <option value="{{ wallet._id }}" disabled data-balance="0">
                                    {{ wallet.name }} ({{ wallet.type or 'bank' }}) - Insufficient funds
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                            <!-- Current Balance Display -->
                            <div class="mt-2" id="fromWalletBalanceDisplay" style="display: none;">
                                <div class="alert alert-light mb-0">
                                    <i class="fas fa-wallet me-2"></i>
                                    <strong>Current Balance:</strong> <span id="fromWalletBalance">IDR 0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-5 col-sm-6 mb-4">
                            <label for="transfer_to_wallet" class="form-label">To Wallet</label>
                            <select class="form-select form-select-lg" id="transfer_to_wallet" name="to_wallet_id" required>
                                <option value="">Select Destination Wallet</option>
                                {% for wallet in wallets %}
                                <option value="{{ wallet._id }}">
                                    {{ wallet.name }} ({{ wallet.type or 'bank' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row justify-content-center">
                        <div class="col-md-10 mb-4">
                            <label for="transfer_amount" class="form-label">Transfer Amount</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">IDR</span>
                                <input type="text" class="form-control form-control-lg text-center" id="transfer_amount" name="amount" required placeholder="1.000.000">
                            </div>
                            <small class="form-text text-muted">Format: 1.000.000 (gunakan titik sebagai separator ribuan)</small>
                        </div>
                    </div>
                    
                    <div class="row justify-content-center">
                        <div class="col-md-10 mb-4">
                            <label for="transfer_fee" class="form-label">Admin Fee (Optional)</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">IDR</span>
                                <input type="text" class="form-control form-control-lg text-center" id="transfer_fee" name="admin_fee" placeholder="0">
                            </div>
                            <small class="form-text text-muted">Optional admin fee for the transfer</small>
                        </div>
                    </div>
                    


                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="submitTransfer()">
                    <i class="fas fa-exchange-alt me-1"></i>Transfer Money
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1" aria-labelledby="transactionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionDetailsModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Transaction Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="transactionDetailsContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter Modal -->
<div class="modal fade" id="searchFilterModal" tabindex="-1" aria-labelledby="searchFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchFilterModalLabel">
                    <i class="fas fa-search me-2"></i>Search & Filter Transactions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="GET" action="/transactions" id="modalFilterForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="modalSearch" class="form-label">Search</label>
                            <input type="text" class="form-control" id="modalSearch" name="search" placeholder="Search transactions...">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modalWalletId" class="form-label">Wallet</label>
                            <select class="form-select" id="modalWalletId" name="wallet_id">
                                <option value="">All Wallets</option>
                                {% for wallet in wallets %}
                                <option value="{{ wallet._id }}" {% if current_wallet_id == wallet._id %}selected{% endif %}>
                                    {{ wallet.name }} ({{ wallet.type or 'bank' }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modalType" class="form-label">Type</label>
                            <select class="form-select" id="modalType" name="type">
                                <option value="">All Types</option>
                                <option value="income" {% if current_type == 'income' %}selected{% endif %}>Income</option>
                                <option value="expense" {% if current_type == 'expense' %}selected{% endif %}>Expense</option>
                                <option value="transfer" {% if current_type == 'transfer' %}selected{% endif %}>Transfer</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modalCategoryId" class="form-label">Category</label>
                            <select class="form-select" id="modalCategoryId" name="category_id">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category._id }}" {% if current_category_id == category._id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modalDateFrom" class="form-label">Date From</label>
                            <input type="date" class="form-control" id="modalDateFrom" name="date_from" value="{{ current_date_from or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modalDateTo" class="form-label">Date To</label>
                            <input type="date" class="form-control" id="modalDateTo" name="date_to" value="{{ current_date_to or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modalAmountMin" class="form-label">Min Amount</label>
                            <input type="number" class="form-control" id="modalAmountMin" name="amount_min" placeholder="0" value="{{ current_amount_min or '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modalAmountMax" class="form-label">Max Amount</label>
                            <input type="number" class="form-control" id="modalAmountMax" name="amount_max" placeholder="0" value="{{ current_amount_max or '' }}">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-danger" onclick="clearFilters()">Clear All</button>
                <button type="button" class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-bullseye me-2"></i>Financial Goals
                </h1>
                <div class="d-flex gap-2">
                    <a href="/dashboard" class="btn btn-outline-primary">
                        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                    </a>
                    <a href="/transactions" class="btn btn-outline-primary">
                        <i class="fas fa-list me-1"></i>Transactions
                    </a>
                    <a href="/settings" class="btn btn-outline-primary">
                        <i class="fas fa-cog me-1"></i>Settings
                    </a>
                </div>
            </div>

            <!-- Add Goal Form -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-plus"></i> Add New Goal</h5>
                </div>
                <div class="card-body">
                    <form id="form-goal">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="title" class="form-label">Goal Title</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="title" 
                                       name="title" 
                                       placeholder="e.g., Tabungan 1 tahun 50jt" 
                                       required>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <label for="target_amount" class="form-label">Target Amount</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="target_amount" 
                                       name="target_amount" 
                                       step="0.01" 
                                       placeholder="50000000" 
                                       required>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <label for="currency" class="form-label">Currency</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="currency" 
                                       name="currency" 
                                       value="IDR" 
                                       readonly>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="target_date" class="form-label">Target Date</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="target_date" 
                                       name="target_date">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="scope_id" class="form-label">Scope (Optional)</label>
                                <select class="form-select" id="scope_id" name="scope_id">
                                    <option value="">Select Scope</option>
                                    <!-- Will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" 
                                      id="description" 
                                      name="description" 
                                      rows="3" 
                                      placeholder="Describe your financial goal..."></textarea>
                        </div>
                        
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>Add Goal
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Goals Display -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bullseye"></i> Your Financial Goals</h5>
                </div>
                <div class="card-body">
                    <div id="cards-goals" class="row">
                        <!-- Goals will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/app.js"></script>
<script>
// Goals-specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Load scopes for scope dropdown
    loadScopesForGoals();
    
    // Load goals
    loadGoals();
});

async function loadScopesForGoals() {
    try {
        const response = await fetch('/api/scopes/');
        if (response.ok) {
            const scopes = await response.json();
            const scopeSelect = document.getElementById('scope_id');
            if (scopeSelect) {
                scopeSelect.innerHTML = '<option value="">Select Scope</option>' + 
                    scopes.map(scope => `<option value="${scope._id}">${scope.name}</option>`).join('');
            }
        }
    } catch (error) {
        console.error('Error loading scopes for goals:', error);
    }
}

async function loadGoals() {
    try {
        const response = await fetch('/api/goals/');
        if (response.ok) {
            const goals = await response.json();
            updateGoalsDisplay(goals);
        }
    } catch (error) {
        console.error('Error loading goals:', error);
    }
}

function updateGoalsDisplay(goals) {
    const goalsContainer = document.getElementById('cards-goals');
    if (!goalsContainer) return;
    
    if (goals.length === 0) {
        goalsContainer.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-bullseye fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">No financial goals set yet</h6>
                    <p class="text-muted small">Set your first financial goal to start tracking your progress</p>
                </div>
            </div>
        `;
        return;
    }
    
    goalsContainer.innerHTML = goals.map(goal => {
        const targetAmount = goal.target_amount ? formatCurrency(goal.target_amount) : '0';
        const targetDate = goal.target_date ? formatDate(goal.target_date) : 'No deadline';
        const scopeName = goal.scope_id || 'All Scopes';
        
        return `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-bullseye me-1"></i>${goal.title || 'Untitled Goal'}</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <strong>Target:</strong> ${targetAmount}
                        </div>
                        <div class="mb-2">
                            <strong>Deadline:</strong> ${targetDate}
                        </div>
                        <div class="mb-2">
                            <strong>Scope:</strong> ${scopeName}
                        </div>
                        ${goal.description ? `<div class="mb-2"><strong>Description:</strong> ${goal.description}</div>` : ''}
                    </div>
                    <div class="card-footer bg-light">
                        <div class="btn-group btn-group-sm w-100">
                            <button class="btn btn-outline-primary" onclick="editGoal('${goal._id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteGoal('${goal._id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Utility functions
function formatCurrency(amount) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
    }).format(amount);
}

function formatDate(timestamp) {
    if (!timestamp) return 'No deadline';
    return new Date(timestamp * 1000).toLocaleDateString('id-ID', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

// Goal form submission
document.getElementById('form-goal').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const payload = {
        title: formData.get('title'),
        target_amount: parseFloat(formData.get('target_amount')),
        currency: formData.get('currency'),
        target_date: formData.get('target_date') ? Math.floor(new Date(formData.get('target_date')).getTime() / 1000) : null,
        scope_id: formData.get('scope_id') || null,
        description: formData.get('description') || ''
    };
    
    try {
        const response = await fetch('/api/goals/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            showAlert('Goal added successfully!', 'success');
            this.reset();
            await loadGoals();
        } else {
            const error = await response.json();
            showAlert(error.error || 'Failed to add goal', 'danger');
        }
    } catch (error) {
        console.error('Error adding goal:', error);
        showAlert('Error adding goal. Please try again.', 'danger');
    }
});

// Edit and delete functions
function editGoal(goalId) {
    // TODO: Implement edit goal functionality
    showAlert('Edit goal functionality coming soon!', 'info');
}

function deleteGoal(goalId) {
    if (confirm('Are you sure you want to delete this goal?')) {
        // TODO: Implement delete goal functionality
        showAlert('Delete goal functionality coming soon!', 'info');
    }
}

// Show alert function (if not already defined)
function showAlert(message, type = 'info') {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of main content
    const main = document.querySelector('main');
    if (main) {
        main.insertBefore(alertDiv, main.firstChild);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
}
</script>
{% endblock %}



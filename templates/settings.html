{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Settings</h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scopeModal">
                        <i class="fas fa-plus"></i> Add Scope
                    </button>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#savingSpaceModal">
                        <i class="fas fa-plus"></i> Add Saving Space
                    </button>
                    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#categoryModal">
                        <i class="fas fa-plus"></i> Add Category
                    </button>
                </div>
            </div>

            <div class="row">
                <!-- Scopes Management -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-folder"></i> Scopes Management</h5>
                        </div>
                        <div class="card-body">
                            {% if scopes %}
                            <div class="list-group list-group-flush">
                                {% for scope in scopes %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">{{ scope.name }}</h6>
                                        <small class="text-muted">{{ scope.description or 'No description' }}</small>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editScope('{{ scope._id }}', '{{ scope.name }}', '{{ scope.description or '' }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteScope('{{ scope._id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-folder fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">No scopes created yet</h6>
                                <p class="text-muted small">Create your first scope to organize your finances</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Saving Spaces Management -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-piggy-bank"></i> Saving Spaces Management</h5>
                        </div>
                        <div class="card-body">
                            {% if wallets %}
                            <div class="list-group list-group-flush">
                                {% for wallet in wallets %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">{{ wallet.name }}</h6>
                                        <small class="text-muted">Type: {{ wallet.type or 'bank' }}</small>
                                        {% if wallet.manual_balance %}
                                        <br><small class="text-primary">Balance: {{ wallet.manual_balance|currency_decimal }}</small>
                                        {% endif %}
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editSavingSpace('{{ wallet._id }}', '{{ wallet.name }}', '{{ wallet.type or 'bank' }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="editBalance('{{ wallet._id }}', '{{ wallet.name }}', {{ wallet.manual_balance or 0 }})">
                                            <i class="fas fa-balance-scale"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteSavingSpace('{{ wallet._id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-piggy-bank fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">No saving spaces created yet</h6>
                                <p class="text-muted small">Create your first saving space to track your money</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Categories Management -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-tags"></i> Categories Management</h5>
                        </div>
                        <div class="card-body">
                            {% if categories %}
                            <div class="list-group list-group-flush">
                                {% for category in categories %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">{{ category.name }}</h6>
                                        <small class="text-muted">{{ category.description or 'No description' }}</small>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editCategory('{{ category._id }}', '{{ category.name }}', '{{ category.description or '' }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteCategory('{{ category._id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">No categories created yet</h6>
                                <p class="text-muted small">Create your first category to organize transactions</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scope Modal -->
<div class="modal fade" id="scopeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scopeModalTitle">Add New Scope</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scopeForm">
                    <input type="hidden" id="scope_id" name="_id">
                    <div class="mb-3">
                        <label for="scope_name" class="form-label">Scope Name *</label>
                        <input type="text" class="form-control" id="scope_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="scope_description" class="form-label">Description</label>
                        <textarea class="form-control" id="scope_description" name="description" rows="3"></textarea>
  </div>
        </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitScope()">Save Scope</button>
            </div>
        </div>
    </div>
</div>

<!-- Saving Space Modal -->
<div class="modal fade" id="savingSpaceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="savingSpaceModalTitle">Add New Saving Space</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="savingSpaceForm">
                    <input type="hidden" id="wallet_id" name="_id">
                    <div class="mb-3">
                        <label for="wallet_name" class="form-label">Saving Space Name *</label>
                        <input type="text" class="form-control" id="wallet_name" name="name" required>
      </div>
                    <div class="mb-3">
                        <label for="wallet_type" class="form-label">Type *</label>
                        <select class="form-select" id="wallet_type" name="type" required>
                            <option value="bank">Bank</option>
                            <option value="ewallet">E-Wallet</option>
                            <option value="saham">Saham</option>
                            <option value="crypto">Crypto</option>
                            <option value="mutual_fund">Mutual Fund</option>
                            <option value="reksadana">Reksadana</option>
                            <option value="obligasi">Obligasi</option>
                            <option value="deposito">Deposito</option>
                            <option value="emas">Emas</option>
                            <option value="properti">Properti</option>
                            <option value="cash">Cash</option>
                            <option value="other">Other</option>
          </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitSavingSpace()">Save Saving Space</button>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="category_id" name="_id">
                    <div class="mb-3">
                        <label for="category_name" class="form-label">Category Name *</label>
                        <input type="text" class="form-control" id="category_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="category_description" class="form-label">Description</label>
                        <textarea class="form-control" id="category_description" name="description" rows="3"></textarea>
                    </div>
        </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitCategory()">Save Category</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Balance Modal -->
<div class="modal fade" id="editBalanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-balance-scale me-2"></i>Edit Manual Balance
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editBalanceForm">
                    <input type="hidden" id="edit_wallet_id" name="wallet_id">
                    
                    <div class="mb-3">
                        <label for="edit_wallet_name" class="form-label">Saving Space</label>
                        <input type="text" class="form-control" id="edit_wallet_name" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_manual_balance" class="form-label">Manual Balance</label>
                        <div class="input-group">
                            <span class="input-group-text">IDR</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="edit_manual_balance" 
                                   name="manual_balance" 
                                   step="0.01" 
                                   min="0" 
                                   required>
                        </div>
                        <div class="form-text">
                            Enter the current balance in your saving space (excluding transactions)
                        </div>
      </div>
        </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveBalance()">
                    <i class="fas fa-save me-1"></i>Save Balance
                </button>
            </div>
      </div>
    </div>
  </div>

<script>
// Scope Functions
function editScope(scopeId, name, description) {
    document.getElementById('scope_id').value = scopeId;
    document.getElementById('scope_name').value = name;
    document.getElementById('scope_description').value = description;
    document.getElementById('scopeModalTitle').textContent = 'Edit Scope';
    new bootstrap.Modal(document.getElementById('scopeModal')).show();
}

function submitScope() {
    const form = document.getElementById('scopeForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    const scopeId = data._id;
    delete data._id;
    
    const method = scopeId ? 'PUT' : 'POST';
    const url = scopeId ? `/api/scopes/${scopeId}` : '/api/scopes/';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data._id || data.message) {
            alert(scopeId ? 'Scope updated successfully!' : 'Scope created successfully!');
            bootstrap.Modal.getInstance(document.getElementById('scopeModal')).hide();
            location.reload();
        } else {
            alert('Failed to save scope');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save scope');
    });
}

function deleteScope(scopeId) {
    if (confirm('Are you sure you want to delete this scope?')) {
        fetch(`/api/scopes/${scopeId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Scope deleted successfully!');
                location.reload();
            } else {
                alert('Failed to delete scope');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete scope');
        });
    }
}

// Saving Space Functions
function editSavingSpace(walletId, name, type) {
    document.getElementById('wallet_id').value = walletId;
    document.getElementById('wallet_name').value = name;
    document.getElementById('wallet_type').value = type;
    document.getElementById('savingSpaceModalTitle').textContent = 'Edit Saving Space';
    new bootstrap.Modal(document.getElementById('savingSpaceModal')).show();
}

function submitSavingSpace() {
    const form = document.getElementById('savingSpaceForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    const walletId = data._id;
    delete data._id;
    
    const method = walletId ? 'PUT' : 'POST';
    const url = walletId ? `/api/wallets/${walletId}` : '/api/wallets/';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data._id || data.message) {
            alert(walletId ? 'Saving space updated successfully!' : 'Saving space created successfully!');
            bootstrap.Modal.getInstance(document.getElementById('savingSpaceModal')).hide();
            location.reload();
        } else {
            alert('Failed to save saving space');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save saving space');
    });
}

function deleteSavingSpace(walletId) {
    if (confirm('Are you sure you want to delete this saving space?')) {
        fetch(`/api/wallets/${walletId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Saving space deleted successfully!');
                location.reload();
            } else {
                alert('Failed to delete saving space');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete saving space');
        });
    }
}

// Category Functions
function editCategory(categoryId, name, description) {
    document.getElementById('category_id').value = categoryId;
    document.getElementById('category_name').value = name;
    document.getElementById('category_description').value = description;
    document.getElementById('categoryModalTitle').textContent = 'Edit Category';
    new bootstrap.Modal(document.getElementById('categoryModal')).show();
}

function submitCategory() {
    const form = document.getElementById('categoryForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    const categoryId = data._id;
    delete data._id;
    
    const method = categoryId ? 'PUT' : 'POST';
    const url = categoryId ? `/api/categories/${categoryId}` : '/api/categories/';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data._id || data.message) {
            alert(categoryId ? 'Category updated successfully!' : 'Category created successfully!');
            bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
            location.reload();
        } else {
            alert('Failed to save category');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save category');
    });
}

function deleteCategory(categoryId) {
    if (confirm('Are you sure you want to delete this category?')) {
        fetch(`/api/categories/${categoryId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Category deleted successfully!');
                location.reload();
            } else {
                alert('Failed to delete category');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete category');
        });
    }
}

// Reset modal forms when opened
document.addEventListener('DOMContentLoaded', function() {
    const modals = ['scopeModal', 'savingSpaceModal', 'categoryModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        modal.addEventListener('show.bs.modal', function() {
            const form = this.querySelector('form');
            form.reset();
            const hiddenInput = form.querySelector('input[type="hidden"]');
            if (hiddenInput) hiddenInput.value = '';
            
            // Reset modal title
            const title = this.querySelector('.modal-title');
            if (modalId === 'scopeModal') title.textContent = 'Add New Scope';
            else if (modalId === 'savingSpaceModal') title.textContent = 'Add New Saving Space';
            else if (modalId === 'categoryModal') title.textContent = 'Add New Category';
        });
    });
});

// Balance Functions
function editBalance(walletId, walletName, currentBalance) {
    // Populate modal
    document.getElementById('edit_wallet_id').value = walletId;
    document.getElementById('edit_wallet_name').value = walletName;
    document.getElementById('edit_manual_balance').value = currentBalance || 0;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editBalanceModal'));
    modal.show();
}

async function saveBalance() {
    const walletId = document.getElementById('edit_wallet_id').value;
    const manualBalance = parseFloat(document.getElementById('edit_manual_balance').value);
    
    if (isNaN(manualBalance) || manualBalance < 0) {
        alert('Please enter a valid balance amount');
        return;
    }
    
    try {
        const response = await fetch(`/api/wallets/${walletId}/balance`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                manual_balance: manualBalance
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('Balance updated successfully!');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editBalanceModal'));
            modal.hide();
            
            // Reload page to show updated data
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to update balance');
        }
    } catch (error) {
        console.error('Error updating balance:', error);
        alert('Error updating balance. Please try again.');
    }
}
</script>
{% endblock %}



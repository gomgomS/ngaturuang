{% extends 'layout.html' %}

{% block content %}
<div class="settings-container">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-cog text-primary me-2"></i>Settings
            </h1>
            <p class="text-muted mb-0">Manage your financial categories, saving spaces, and scopes</p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scopeModal">
                <i class="fas fa-plus me-1"></i>
                <span class="d-none d-sm-inline">Add Scope</span>
                <span class="d-inline d-sm-none">Scope</span>
            </button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#savingSpaceModal">
                <i class="fas fa-plus me-1"></i>
                <span class="d-none d-sm-inline">Add Saving Space</span>
                <span class="d-inline d-sm-none">Space</span>
            </button>
            <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#categoryModal">
                <i class="fas fa-plus me-1"></i>
                <span class="d-none d-sm-inline">Add Category</span>
                <span class="d-inline d-sm-none">Category</span>
            </button>
        </div>
    </div>

    <!-- Settings Cards Row -->
    <div class="row g-4">
        <!-- Scopes Management -->
        <div class="col-12 col-lg-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-primary text-white border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-folder fa-lg me-2"></i>
                        <h5 class="mb-0">Scopes Management</h5>
                    </div>
                </div>
                <div class="card-body">
                    {% if scopes %}
                        <div class="list-group list-group-flush">
                            {% for scope in scopes %}
                            <div class="list-group-item border-0 px-0 py-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1 me-3">
                                        <h6 class="mb-1 fw-medium">{{ scope.name }}</h6>
                                        <small class="text-muted">{{ scope.description or 'No description' }}</small>
                                    </div>
                                    <div class="btn-group btn-group-sm flex-shrink-0">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editScope('{{ scope._id }}', '{{ scope.name }}', '{{ scope.description or '' }}')" title="Edit Scope">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteScope('{{ scope._id }}')" title="Delete Scope">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                <i class="fas fa-folder fa-2x text-muted"></i>
                            </div>
                            <h6 class="text-muted mb-2">No scopes created yet</h6>
                            <p class="text-muted small mb-0">Create your first scope to organize your finances</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Saving Spaces Management -->
        <div class="col-12 col-lg-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-success text-white border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-piggy-bank fa-lg me-2"></i>
                        <h5 class="mb-0">Saving Spaces</h5>
                    </div>
                </div>
                <div class="card-body">
                    {% if wallets %}
                        <div class="list-group list-group-flush">
                            {% for wallet in wallets %}
                            <div class="list-group-item border-0 px-0 py-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1 me-3">
                                        <h6 class="mb-1 fw-medium">{{ wallet.name }}</h6>
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <span class="badge bg-secondary">{{ wallet.type or 'bank' }}</span>
                                            {% if wallet.manual_balance %}
                                            <span class="text-success fw-medium">{{ wallet.manual_balance|currency_decimal }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="btn-group btn-group-sm flex-shrink-0">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editSavingSpace('{{ wallet._id }}', '{{ wallet.name }}', '{{ wallet.type or 'bank' }}')" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-info btn-sm" onclick="editBalance('{{ wallet._id }}', '{{ wallet.name }}', {{ wallet.manual_balance or 0 }})" title="Edit Balance">
                                            <i class="fas fa-balance-scale"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteSavingSpace('{{ wallet._id }}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                <i class="fas fa-piggy-bank fa-2x text-muted"></i>
                            </div>
                            <h6 class="text-muted mb-2">No saving spaces created yet</h6>
                            <p class="text-muted small mb-0">Create your first saving space to track your money</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Categories Management -->
        <div class="col-12 col-lg-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-info text-white border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-tags fa-lg me-2"></i>
                        <h5 class="mb-0">Categories</h5>
                    </div>
                </div>
                <div class="card-body">
                    {% if categories %}
                        <div class="list-group list-group-flush">
                            {% for category in categories %}
                            <div class="list-group-item border-0 px-0 py-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1 me-3">
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <h6 class="mb-0 fw-medium">{{ category.name }}</h6>
                                            {% if category.is_system %}
                                                <span class="badge bg-info">System</span>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">{{ category.description or 'No description' }}</small>
                                    </div>
                                    {% if not category.is_system %}
                                    <div class="btn-group btn-group-sm flex-shrink-0">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editCategory('{{ category._id }}', '{{ category.name }}', '{{ category.description or '' }}', {{ 'true' if category.is_system else 'false' }})" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteCategory('{{ category._id }}', {{ 'true' if category.is_system else 'false' }})" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                <i class="fas fa-tags fa-2x text-muted"></i>
                            </div>
                            <h6 class="text-muted mb-2">No categories created yet</h6>
                            <p class="text-muted small mb-0">Create your first category to organize transactions</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Row -->
    <div class="row g-3 mt-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body py-3">
                    <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 rounded-circle mb-2" style="width: 50px; height: 50px;">
                        <i class="fas fa-folder fa-lg text-primary"></i>
                    </div>
                    <h4 class="mb-1 text-primary">{{ scopes|length if scopes else 0 }}</h4>
                    <small class="text-muted">Total Scopes</small>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body py-3">
                    <div class="d-inline-flex align-items-center justify-content-center bg-success bg-opacity-10 rounded-circle mb-2" style="width: 50px; height: 50px;">
                        <i class="fas fa-piggy-bank fa-lg text-success"></i>
                    </div>
                    <h4 class="mb-1 text-success">{{ wallets|length if wallets else 0 }}</h4>
                    <small class="text-muted">Saving Spaces</small>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body py-3">
                    <div class="d-inline-flex align-items-center justify-content-center bg-info bg-opacity-10 rounded-circle mb-2" style="width: 50px; height: 50px;">
                        <i class="fas fa-tags fa-lg text-info"></i>
                    </div>
                    <h4 class="mb-1 text-info">{{ categories|length if categories else 0 }}</h4>
                    <small class="text-muted">Categories</small>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body py-3">
                    <div class="d-inline-flex align-items-center justify-content-center bg-warning bg-opacity-10 rounded-circle mb-2" style="width: 50px; height: 50px;">
                        <i class="fas fa-cog fa-lg text-warning"></i>
                    </div>
                    <h4 class="mb-1 text-warning">3</h4>
                    <small class="text-muted">Settings Tabs</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scope Modal -->
<div class="modal fade" id="scopeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title" id="scopeModalTitle">
                    <i class="fas fa-folder me-2"></i>Add New Scope
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scopeForm">
                    <input type="hidden" id="scope_id" name="_id">
                    <div class="mb-3">
                        <label for="scope_name" class="form-label fw-medium">Scope Name *</label>
                        <input type="text" class="form-control form-control-lg" id="scope_name" name="name" required placeholder="Enter scope name">
                    </div>
                    <div class="mb-3">
                        <label for="scope_description" class="form-label fw-medium">Description</label>
                        <textarea class="form-control" id="scope_description" name="description" rows="3" placeholder="Enter scope description (optional)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitScope()">
                    <i class="fas fa-save me-1"></i>Save Scope
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Saving Space Modal -->
<div class="modal fade" id="savingSpaceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white border-0">
                <h5 class="modal-title" id="savingSpaceModalTitle">
                    <i class="fas fa-piggy-bank me-2"></i>Add New Saving Space
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="savingSpaceForm">
                    <input type="hidden" id="wallet_id" name="_id">
                    <div class="mb-3">
                        <label for="wallet_name" class="form-label fw-medium">Saving Space Name *</label>
                        <input type="text" class="form-control form-control-lg" id="wallet_name" name="name" required placeholder="Enter saving space name">
                    </div>
                    <div class="mb-3">
                        <label for="wallet_type" class="form-label fw-medium">Type *</label>
                        <select class="form-select form-select-lg" id="wallet_type" name="type" required>
                            <option value="">Select type...</option>
                            <option value="bank">Bank</option>
                            <option value="ewallet">E-Wallet</option>
                            <option value="saham">Saham</option>
                            <option value="crypto">Crypto</option>
                            <option value="mutual_fund">Mutual Fund</option>
                            <option value="reksadana">Reksadana</option>
                            <option value="obligasi">Obligasi</option>
                            <option value="deposito">Deposito</option>
                            <option value="emas">Emas</option>
                            <option value="properti">Properti</option>
                            <option value="cash">Cash</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitSavingSpace()">
                    <i class="fas fa-save me-1"></i>Save Saving Space
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-info text-white border-0">
                <h5 class="modal-title" id="categoryModalTitle">
                    <i class="fas fa-tags me-2"></i>Add New Category
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="category_id" name="_id">
                    <div class="mb-3">
                        <label for="category_name" class="form-label fw-medium">Category Name *</label>
                        <input type="text" class="form-control form-control-lg" id="category_name" name="name" required placeholder="Enter category name">
                    </div>
                    <div class="mb-3">
                        <label for="category_description" class="form-label fw-medium">Description</label>
                        <textarea class="form-control" id="category_description" name="description" rows="3" placeholder="Enter category description (optional)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="submitCategory()">
                    <i class="fas fa-save me-1"></i>Save Category
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Balance Modal -->
<div class="modal fade" id="editBalanceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning text-white border-0">
                <h5 class="modal-title">
                    <i class="fas fa-balance-scale me-2"></i>Edit Manual Balance
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editBalanceForm">
                    <input type="hidden" id="edit_wallet_id" name="wallet_id">
                    
                    <div class="mb-3">
                        <label for="edit_wallet_name" class="form-label fw-medium">Saving Space</label>
                        <input type="text" class="form-control form-control-lg" id="edit_wallet_name" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_manual_balance" class="form-label fw-medium">Manual Balance</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-light">IDR</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="edit_manual_balance" 
                                   name="manual_balance" 
                                   step="0.01" 
                                   min="0" 
                                   required
                                   placeholder="0.00">
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Enter the current balance in your saving space (excluding transactions)
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="saveBalance()">
                    <i class="fas fa-save me-1"></i>Save Balance
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Mobile-specific styles -->
<style>
.settings-container {
    padding: 0;
}

@media (max-width: 767.98px) {
    .settings-container {
        padding: 0.5rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .btn {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }
    
    .card-title {
        font-size: 0.875rem;
    }
    
    .h3 {
        font-size: 1.5rem;
    }
    
    .list-group-item {
        padding: 0.75rem 0;
    }
    
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
}

@media (max-width: 575.98px) {
    .settings-container {
        padding: 0.25rem;
    }
    
    .card-body {
        padding: 0.75rem;
    }
    
    .btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
    }
    
    .h3 {
        font-size: 1.25rem;
    }
    
    .card-title {
        font-size: 0.8rem;
    }
    
    .modal-dialog {
        margin: 0.5rem;
    }
}

.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.list-group-item:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.btn-group .btn {
    border-radius: 0.375rem !important;
}

.btn-group .btn:not(:last-child) {
    margin-right: 0.25rem;
}
</style>

<script>
// Scope Functions
function editScope(scopeId, name, description) {
    // Clear form first
    document.getElementById('scopeForm').reset();
    
    // Set values
    document.getElementById('scope_id').value = scopeId;
    document.getElementById('scope_name').value = name;
    document.getElementById('scope_description').value = description;
    
    // Change modal title
    document.getElementById('scopeModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Scope';
    
    // Show modal
    new bootstrap.Modal(document.getElementById('scopeModal')).show();
}

function submitScope() {
    const form = document.getElementById('scopeForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    const scopeId = data._id;
    delete data._id;
    
    const method = scopeId ? 'PUT' : 'POST';
    const url = scopeId ? `/api/scopes/${scopeId}` : '/api/scopes/';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data._id || data.message) {
            alert(scopeId ? 'Scope updated successfully!' : 'Scope created successfully!');
            bootstrap.Modal.getInstance(document.getElementById('scopeModal')).hide();
            location.reload();
        } else {
            alert('Failed to save scope');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save scope');
    });
}

function deleteScope(scopeId) {
    if (confirm('Are you sure you want to delete this scope?')) {
        fetch(`/api/scopes/${scopeId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Scope deleted successfully!');
                location.reload();
            } else {
                alert('Failed to delete scope');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete scope');
        });
    }
}

// Saving Space Functions
function editSavingSpace(walletId, name, type) {
    // Clear form first
    document.getElementById('savingSpaceForm').reset();
    
    // Set values
    document.getElementById('wallet_id').value = walletId;
    document.getElementById('wallet_name').value = name;
    document.getElementById('wallet_type').value = type;
    
    // Change modal title
    document.getElementById('savingSpaceModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Saving Space';
    
    // Show modal
    new bootstrap.Modal(document.getElementById('savingSpaceModal')).show();
}

function submitSavingSpace() {
    const form = document.getElementById('savingSpaceForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    const walletId = data._id;
    delete data._id;
    
    const method = walletId ? 'PUT' : 'POST';
    const url = walletId ? `/api/wallets/${walletId}` : '/api/wallets/';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data._id || data.message) {
            alert(walletId ? 'Saving space updated successfully!' : 'Saving space created successfully!');
            bootstrap.Modal.getInstance(document.getElementById('savingSpaceModal')).hide();
            location.reload();
        } else {
            alert('Failed to save saving space');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save saving space');
    });
}

function deleteSavingSpace(walletId) {
    if (confirm('Are you sure you want to delete this saving space?')) {
        fetch(`/api/wallets/${walletId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Saving space deleted successfully!');
                location.reload();
            } else {
                alert('Failed to delete saving space');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete saving space');
        });
    }
}

// Category Functions
function editCategory(categoryId, name, description, isSystem) {
    // Prevent editing system categories
    if (isSystem) {
        alert('System categories cannot be edited or deleted.');
        return;
    }
    
    // Clear form first
    document.getElementById('categoryForm').reset();
    
    // Set values
    document.getElementById('category_id').value = categoryId;
    document.getElementById('category_name').value = name;
    document.getElementById('category_description').value = description;
    
    // Change modal title
    document.getElementById('categoryModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Category';
    
    // Show modal
    new bootstrap.Modal(document.getElementById('categoryModal')).show();
}

function submitCategory() {
    const form = document.getElementById('categoryForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    const categoryId = data._id;
    delete data._id;
    
    const method = categoryId ? 'PUT' : 'POST';
    const url = categoryId ? `/api/categories/${categoryId}` : '/api/categories/';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data._id || data.message) {
            alert(categoryId ? 'Category updated successfully!' : 'Category created successfully!');
            bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
            location.reload();
        } else {
            alert('Failed to save category');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save category');
    });
}

function deleteCategory(categoryId, isSystem) {
    // Prevent deleting system categories
    if (isSystem) {
        alert('System categories cannot be edited or deleted.');
        return;
    }
    
    if (confirm('Are you sure you want to delete this category?')) {
        fetch(`/api/categories/${categoryId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Category deleted successfully!');
                location.reload();
            } else {
                alert('Failed to delete category');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete category');
        });
    }
}

// Reset modal forms when opened for new items
document.addEventListener('DOMContentLoaded', function() {
    const modals = ['scopeModal', 'savingSpaceModal', 'categoryModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        modal.addEventListener('show.bs.modal', function(event) {
            // Only reset if it's not triggered by edit button
            if (!event.relatedTarget || !event.relatedTarget.hasAttribute('onclick')) {
                const form = this.querySelector('form');
                form.reset();
                const hiddenInput = form.querySelector('input[type="hidden"]');
                if (hiddenInput) hiddenInput.value = '';
                
                // Reset modal title
                const title = this.querySelector('.modal-title');
                if (modalId === 'scopeModal') title.innerHTML = '<i class="fas fa-folder me-2"></i>Add New Scope';
                else if (modalId === 'savingSpaceModal') title.innerHTML = '<i class="fas fa-piggy-bank me-2"></i>Add New Saving Space';
                else if (modalId === 'categoryModal') title.innerHTML = '<i class="fas fa-tags me-2"></i>Add New Category';
            }
        });
        
        // Reset form when modal is hidden
        modal.addEventListener('hidden.bs.modal', function() {
            const form = this.querySelector('form');
            form.reset();
            const hiddenInput = form.querySelector('input[type="hidden"]');
            if (hiddenInput) hiddenInput.value = '';
            
            // Reset modal title back to "Add New"
            const title = this.querySelector('.modal-title');
            if (modalId === 'scopeModal') title.innerHTML = '<i class="fas fa-folder me-2"></i>Add New Scope';
            else if (modalId === 'savingSpaceModal') title.innerHTML = '<i class="fas fa-piggy-bank me-2"></i>Add New Saving Space';
            else if (modalId === 'categoryModal') title.innerHTML = '<i class="fas fa-tags me-2"></i>Add New Category';
        });
    });
});

// Balance Functions
function editBalance(walletId, walletName, currentBalance) {
    // Populate modal
    document.getElementById('edit_wallet_id').value = walletId;
    document.getElementById('edit_wallet_name').value = walletName;
    document.getElementById('edit_manual_balance').value = currentBalance || 0;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editBalanceModal'));
    modal.show();
}

async function saveBalance() {
    const walletId = document.getElementById('edit_wallet_id').value;
    const manualBalance = parseFloat(document.getElementById('edit_manual_balance').value);
    
    if (isNaN(manualBalance) || manualBalance < 0) {
        alert('Please enter a valid balance amount');
        return;
    }
    
    try {
        const response = await fetch(`/api/wallets/${walletId}/balance`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                manual_balance: manualBalance
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('Balance updated successfully!');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editBalanceModal'));
            modal.hide();
            
            // Reload page to show updated data
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to update balance');
        }
    } catch (error) {
        console.error('Error updating balance:', error);
        alert('Error updating balance. Please try again.');
    }
}
</script>
{% endblock %}


